@using KontrolaPakowania.Shared.DTOs.Requests
@using KontrolaPakowania.Shared.Enums
@using KontrolaPakowania.Shared.Helpers

@page "/kontrola-pakowania/{jl}"
@layout NoNavLayout
@inherits ProtectedPageBase

@inject IJSRuntime JSRuntime
@inject PackingService PackingService
@inject WorkstationService WorkstationService
@inject UserSessionService UserSession
@inject AuthService AuthService
@inject ShipmentService ShipmentService
@inject ClientPrinterService ClientPrinterService;

<div class="container-fluid d-flex flex-column vh-100 p-3 pack-control">
    <div class="d-flex align-items-center mb-3 header-row">
        @if (JlItems != null && JlItems.Any() && Country != "PL")
        {
            <!-- First image placeholder (Export) -->
            <div class="header-image-placeholder me-2">
                <img src="images/exp.jpg" alt="Export" />
            </div>
        }

        @if (CurrentJl != null && CurrentJl.Courier != Courier.Unknown)
        {
            <!-- Second image placeholder (Courier) -->
            <div class="header-image-placeholder me-3">
                <img src="@Utils.GetCourierSrc(CurrentJl.LogoCourier)" alt="@CurrentJl.LogoCourier" />
            </div>
        }

        <div class="me-3">
            <h4>Operator: @Username</h4>
        </div>

        <!-- Header text -->
        <div class="flex-grow-1 text-center">
            <h2 class="scan-blink">Zeskanuj Towar</h2>
        </div>

        <ManagerControlModal OnButtonClick="HandleManagerClick"
                             OnRequestPassword="OnManagerButtonClick"
                             ShowPackingButtons="true"
                             @ref="ManagerModal" />

    </div>


    <!-- Full-width input -->
    <div class="mb-3 flex-shrink-0">
        <input type="text" @ref="itemInputRef" @onkeydown="HandleCodeInput" class="form-control form-control-lg" placeholder="Skanuj kod..." />
    </div>

    <!-- Tables row -->
    <div class="row g-3 flex-grow-1">

        <!-- Left table -->
        <div class="col-12 col-lg-8 d-flex flex-column">
            <div class="card shadow-sm flex-grow-1 d-flex flex-column">
                <div class="card-header d-flex justify-content-between">
                    <span>Do spakowania</span>
                    <span>
                        Waga: @(JlItems != null && JlItems.Any()
                                                ? JlItems.Sum(w => w.Weight * w.JlQuantity).ToString("F2")
                                                : "0") kg
                    </span>
                </div>
                <div class="table-responsive flex-grow-1 overflow-auto">
                    <table class="table custom-striped table-hover align-middle mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Kod</th>
                                <th>Ilość</th>
                                <th>Nazwa</th>
                                <th>Obraz</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (JlItems == null)
                            {
                                <tr><td colspan="4" class="text-center">Ładowanie...</td></tr>
                            }
                            else if (!JlItems.Any())
                            {
                                <tr><td colspan="4" class="text-center text-muted">Brak danych</td></tr>
                            }
                            else
                            {
                                @foreach (var item in JlItems)
                                {
                                    var rowClass = HighlightedRows.Contains(item.Code) ? "table-warning" : "";

                                    <tr class="@rowClass clickable-row" @ondblclick="() => OpenProductModal(item)">
                                        <td>@item.Code</td>
                                        <td>@item.JlQuantity</td>
                                        <td>@item.Name</td>
                                        <td>
                                            <img src="@Utils.GetImageSrc(item.Image)" class="jl-item-img rounded" />
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Right table -->
        <div class="col-12 col-lg-4 d-flex flex-column">
            <div class="card shadow-sm flex-grow-1 d-flex flex-column">
                <div class="card-header d-flex justify-content-between">
                    <span>Spakowane</span>
                    <span>
                        Waga: @(PackedItems.Any()
                                                ? PackedItems.Sum(w => w.Weight * w.JlQuantity).ToString("F2")
                                                : "0") kg
                    </span>
                </div>
                <div class="table-responsive flex-grow-1 overflow-auto">
                    <table class="table custom-striped table-hover align-middle mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Kod</th>
                                <th>Ilość</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (!PackedItems.Any())
                            {
                                <tr><td colspan="2" class="text-center text-muted">Jeszcze nic nie spakowano</td></tr>
                            }
                            else
                            {
                                @foreach (var packed in PackedItems)
                                {
                                    var isSelected = packed == SelectedPackedItem ? "table-danger" : "";
                                    <tr class="@isSelected" @onclick="() => SelectPackedItem(packed)">
                                        <td>@packed.Code</td>
                                        <td>@packed.JlQuantity</td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- Buttons at the bottom -->
    <div class="row g-2 mt-3 flex-shrink-0">
        <div class="col-6 col-md">
            <button class="btn btn-warning w-100 h-100 py-4 fs-5">Następny karton/paczka</button>
        </div>
        @if (Settings != null && Settings.PackingLocation == PackingLocation.Dół)
        {
            <div class="col-6 col-md">
                <button class="btn btn-warning w-100 h-100 py-4 fs-5">Bufor</button>
            </div>
        }
        <div class="col-6 col-md">
            <button class="btn btn-danger w-100 h-100 py-4 fs-5" @onclick="MoveBackToLeft">Usuń pozycję</button>
        </div>
        <div class="col-6 col-md">
            <button class="btn btn-danger w-100 h-100 py-4 fs-5" @onclick="Close" disabled="@(PackedItems.Any())">Zamknij</button>
        </div>
        <div class="col-6 col-md">
            <button class="btn btn-success w-100 h-100 py-4 fs-5" @onclick="FinishPacking">Zakończ</button>
        </div>
    </div>

</div>

@if (ShowProductModal && SelectedItem != null)
{
    <ProductSelectModal Product="SelectedItem"
                        OnConfirm="MoveToRight"
                        OnClose="() => ShowProductModal = false" />
}

@if (ShowPasswordModal)
{
    <PasswordModal Title="Wpisz hasło"
                   OnConfirm="HandlePasswordConfirm"
                   OnClose="() => ShowPasswordModal = false" />
}

<CourierModal @ref="CourierModal" />
<LoggedOperatorsModal @ref="LoggedOperatorsModal" />
<JlInProgressModal @ref="JlInProgressModal" />
<PackingJlItemsModal @ref="PackingJlItemsModal" />
<TextBoxModal @ref="TextBoxModal" />

<ConfirmDialog @ref="confirmDialog"
               Title="Zamknij"
               Message="Czy na pewno chcesz zamknąć?"
               OnCancelClicked="HideConfirm"
               OnConfirmClicked="ConfirmClose" />

<Toast @ref="ToastError" Title="Error" Color="danger" />

@code {
    [Parameter] public string Jl { get; set; } = string.Empty;

    private JlDto CurrentJl = new();
    private List<JlItemDto> JlItems = new();
    private List<JlItemDto> PackedItems = new();
    private WorkstationSettings Settings = new();
    private HashSet<string> HighlightedRows = new();
    private ElementReference itemInputRef;
    private string Username = string.Empty;
    private string Country = string.Empty;

    private Toast ToastError = new();
    private ConfirmDialog confirmDialog = new();
    private ManagerControlModal ManagerModal = new();
    private TextBoxModal TextBoxModal = new();
    private CourierModal CourierModal = new();
    private LoggedOperatorsModal LoggedOperatorsModal = new();
    private JlInProgressModal JlInProgressModal = new();
    private PackingJlItemsModal PackingJlItemsModal = new();
    private bool ShowProductModal = false;
    private bool ShowPasswordModal = false;
    private PasswordPurpose CurrentPasswordPurpose = PasswordPurpose.None;

    private JlItemDto? SelectedItem;
    private JlItemDto? SelectedPackedItem;

    protected override async Task OnInitializedAsync()
    {
        await LoadData();

        JlInProgressDto jlRealization = new JlInProgressDto
        {
            Name = CurrentJl.Name,
            Courier = CurrentJl.CourierName,
            ClientName = CurrentJl.ClientName,
            StationNumber = Settings.StationNumber,
            Date = DateTime.Now,
            User = UserSession.Username
        };

        await PackingService.AddJlRealization(jlRealization);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("blazorFocus.focusElementRef", itemInputRef);
        }
    }

    private async Task LoadData()
    {
        try
        {
            Settings = await WorkstationService.GetSettingsAsync();
            Username = UserSession.Username;
            JlItems = await PackingService.GetJlItems(Jl, Settings.PackingLocation);
            CurrentJl = await PackingService.GetJlInfoByCode(Jl, Settings.PackingLocation);
            Country = JlItems.FirstOrDefault().Country;
        }
        catch (Exception ex)
        {
            JlItems = new List<JlItemDto>();

            await ToastError.Show( $"Błąd przy próbie pobrania zawartości kuwety: {ex.Message}");
            await Task.Delay(7000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
        }
        StateHasChanged();
    }

    private void OpenProductModal(JlItemDto item)
    {
        SelectedItem = item;
        ShowProductModal = true;
    }

    private async void MoveToRight(decimal qty)
    {
        try
        {
            if (SelectedItem == null || JlItems == null) return;

            if (qty == SelectedItem.DocumentQuantity)
            {
                // Full quantity selected -> move whole product
                PackedItems.Add(SelectedItem);
                JlItems.Remove(SelectedItem);
            }
            else
            {
                // Partial quantity selected -> highlight row and move only part
                var existingPacked = PackedItems.FirstOrDefault(p => p.Code == SelectedItem.Code);
                HighlightedRows.Add(SelectedItem.Code);

                if (existingPacked != null)
                {
                    existingPacked.JlQuantity += qty;
                }
                else
                {
                    PackedItems.Add(new JlItemDto
                        {
                            Id = SelectedItem.Id,
                            Code = SelectedItem.Code,
                            Name = SelectedItem.Name,
                            SupplierCode = SelectedItem.SupplierCode,
                            DocumentQuantity = SelectedItem.DocumentQuantity,
                            JlQuantity = qty,
                            Weight = SelectedItem.Weight,
                            Image = SelectedItem.Image,
                            ProductType = SelectedItem.ProductType,
                            Country = SelectedItem.Country,
                            Unit = SelectedItem.Unit,
                            DocumentId = SelectedItem.DocumentId,
                            JlCode = SelectedItem.JlCode
                        });
                }

                // Reduce quantity left in left table
                SelectedItem.JlQuantity -= qty;

                if (SelectedItem.JlQuantity <= 0)
                {
                    JlItems.Remove(SelectedItem);
                }
            }
        }
        catch (Exception ex)
        {
            await ToastError.Show($"Błąd przy próbie spakowania towaru: {ex.Message}");
            await Task.Delay(7000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
        }
        finally
        {

            ShowProductModal = false;
            SelectedItem = null;
            await JSRuntime.InvokeVoidAsync("blazorFocus.focusElementRef", itemInputRef);
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task MoveAllToRight()
    {
        try
        {
            if (JlItems == null || !JlItems.Any()) return;

            foreach (var item in JlItems.ToList())
            {
                var existingPacked = PackedItems.FirstOrDefault(p => p.Code == item.Code);

                if (existingPacked != null)
                {
                    existingPacked.JlQuantity += item.JlQuantity;
                }
                else
                {
                    PackedItems.Add(new JlItemDto
                    {
                        Id = item.Id,
                        Code = item.Code,
                        Name = item.Name,
                        SupplierCode = item.SupplierCode,
                        DocumentQuantity = item.DocumentQuantity,
                        JlQuantity = item.JlQuantity,
                        Weight = item.Weight,
                        Image = item.Image,
                        ProductType = item.ProductType,
                        Country = item.Country,
                        Unit = item.Unit,
                        DocumentId = item.DocumentId,
                        JlCode = item.JlCode
                    });
                }

                JlItems.Remove(item);
            }
        }
        catch (Exception ex)
        {
            await ToastError.Show($"Błąd przy próbie spakowania towaru: {ex.Message}");
            await Task.Delay(7000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
        }
        finally
        {
            ShowProductModal = false;
            SelectedItem = null;
            await JSRuntime.InvokeVoidAsync("blazorFocus.focusElementRef", itemInputRef);
            await InvokeAsync(StateHasChanged);
        }
    }



    private async Task HandleCodeInput(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            try
            {
                var code = await JSRuntime.InvokeAsync<string>("blazorFocus.getValue", itemInputRef);
                if (!string.IsNullOrEmpty(code) && JlItems != null)
                {
                    // Search by code, barcode, or supplier code
                    var item = JlItems.FirstOrDefault(x =>
                        string.Equals(x.Code, code, StringComparison.OrdinalIgnoreCase) ||
                        string.Equals(x.SupplierCode, code, StringComparison.OrdinalIgnoreCase) ||
                        string.Equals(x.Name, code, StringComparison.OrdinalIgnoreCase));

                    if (item != null)
                    {
                        OpenProductModal(item);
                    }
                }
            }
            catch (Exception ex)
            {
                await ToastError.Show($"Błąd przy próbie zaczytania towaru: {ex.Message}");
                await Task.Delay(7000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
            }
            finally
            {
                await JSRuntime.InvokeVoidAsync("blazorFocus.clearValue", itemInputRef);
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private void SelectPackedItem(JlItemDto packed)
    {
        SelectedPackedItem = packed;
    }

    private async void MoveBackToLeft()
    {
        try
        {
            if (SelectedPackedItem == null) return;

            // Find if the item already exists in left list
            var existingLeft = JlItems.FirstOrDefault(j => j.Code == SelectedPackedItem.Code);

            if (existingLeft != null)
            {
                // Add quantity back to existing item
                existingLeft.JlQuantity += SelectedPackedItem.JlQuantity;
            }
            else
            {
                // Recreate the item in left list
                JlItems.Add(SelectedPackedItem);
            }

            // Remove from right
            PackedItems.Remove(SelectedPackedItem);

            // Remove highlight if no longer partially packed
            HighlightedRows.Remove(SelectedPackedItem.Code);

            SelectedPackedItem = null;
        }
        catch (Exception ex)
        {
            await ToastError.Show($"Błąd przy próbie usunięcia towaru: {ex.Message}");
        }
        finally
        {
            await JSRuntime.InvokeVoidAsync("blazorFocus.focusElementRef", itemInputRef);
            await InvokeAsync(StateHasChanged);
        }
    }

    private void Close()
    {
        confirmDialog.Show = true;
        StateHasChanged();
    }

    private void HideConfirm()
    {
        confirmDialog.Show = false;
    }

    private async void ConfirmClose()
    {
        confirmDialog.Show = false;
        await PackingService.RemoveJlRealization(CurrentJl.Name);
        Navigation.NavigateTo("/kontrola-pakowania");
    }

    private async Task HandlePasswordConfirm(string password)
    {
        ShowPasswordModal = false;

        bool valid = await AuthService.ValidatePasswordAsync(password);
        if (!valid)
        {
            await ToastError.Show("Błędne hasło");
            await Task.Delay(4000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
            return;
        }

        switch (CurrentPasswordPurpose)
        {
            case PasswordPurpose.ManagerAction:
                ManagerModal.OpenModal();
                break;
        }

        CurrentPasswordPurpose = PasswordPurpose.None;
    }

    private void OnManagerButtonClick()
    {
        CurrentPasswordPurpose = PasswordPurpose.ManagerAction;
        ShowPasswordModal = true;
        StateHasChanged();
    }

    private async void HandleManagerClick(int returnClick)
    {
        switch (returnClick)
        {
            case 1: /* Etykiety */ break;
            case 2: /* Spakuj */ 
                await MoveAllToRight();
                break;
            case 3: /* Zawartość */
                var barcode = await TextBoxModal.Show("Zawartość kuwety", "Wprowadź kod wewnętrzny", "Kod wewnętrzny");
                if (!string.IsNullOrEmpty(barcode))
                {
                    await PackingJlItemsModal.ShowModal(barcode);
                }
                break;
            case 4: /* Kurier */ 
                if (Country != "PL")
                {
                    await ToastError.Show("Nie można zmienić kuriera na export!");
                    await Task.Delay(4000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
                    return;
                }

                if (CurrentJl.CourierServices.Saturday || CurrentJl.CourierServices._12 || CurrentJl.CourierServices.Return || CurrentJl.CourierServices.Dropshipping)
                {
                    await ToastError.Show($"Przesyłka z dodatkową usługą (Sobota, Zwrotna, 12:00 lub Dropshipping). Nie możesz zmienić kuriera. Nadaj numer wewnętrzny lub wyślij bieżącym kurierem");
                    return;
                }

                var selectedCourier = await CourierModal.ShowModal(CurrentJl.Courier);
                if (selectedCourier.HasValue && selectedCourier.Value != Courier.Unknown)
                {
                    CurrentJl.Courier = selectedCourier.Value;
                    CurrentJl.InitCourierLogo();
                    await InvokeAsync(StateHasChanged);
                }
                break;
            case 5: /* Zalogowani */ 
                await LoggedOperatorsModal.ShowModal();
                break;
            case 6: /* Kuwety podjęte */
                await JlInProgressModal.ShowModal();
                break;
            case 7: /* Zwolnij */ 
                var jlCode = await TextBoxModal.Show("Zwolnij kuwetę", "Wprowadź kod kuwety", "Kod kuwety");
                if (!string.IsNullOrEmpty(jlCode))
                {
                    var releaseSuccess = await PackingService.ReleaseJl(jlCode);
                    if (!releaseSuccess)
                    {
                        await ToastError.Show("Kuweta nie została zwolniona. Spróbuj ponownie.");
                        await Task.Delay(6000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
                        return;
                    }
                }
                break;
            case 8: /* Zmień magazyn */ break;
        }
    }

    private async Task FinishPacking()
    {
        try
        {
            if (!PackedItems.Any())
            {
                await ToastError.Show("Brak spakowanych towarów!");
                await Task.Delay(6000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
                return;
            }

            // Prepare shipment request
            ShipmentRequest shipmentRequest = new ShipmentRequest
            {
                Courier = CurrentJl.Courier,
                RecipientName = CurrentJl.ClientName,
                RecipientCity = "Gdańsk",
                RecipientStreet = "Kazimierza Wielkiego 32/20",
                RecipientPostalCode = "80-180",
                RecipientCountry = "PL",
                RecipientPhone = "797250984",
                RecipientEmail = "krzysztop497@gmail.com",
                Description = $"110129482",
                References = CurrentJl.Name,
                PackageQuantity = 1,
                Weight = PackedItems.Sum(p => p.Weight * p.JlQuantity),
            };

            var response = await ShipmentService.SendPackage(shipmentRequest);

            if (response?.PackageId > 0)
            {
                if (response.LabelBytes != null)
                {
                    var labelContent = Convert.ToBase64String(response.LabelBytes);
                    await ClientPrinterService.PrintAsync(Settings.PrinterLabel, response.LabelType.ToString(), labelContent);
                }
                else
                {
                    await ToastError.Show("Nie udało się wygenerować etykiety kurierskiej!");
                    await Task.Delay(6000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
                }
            }
            else
            {
                await ToastError.Show("Nie udało się wygenerować przesyłki!");
                await Task.Delay(6000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
            }
        }
        catch (Exception ex)
        {
            await ToastError.Show($"Błąd przy próbie finalizacji pakowania: {ex.Message}");
            await Task.Delay(8000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
        }
    }
}
