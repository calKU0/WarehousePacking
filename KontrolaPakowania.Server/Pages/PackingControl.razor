@using KontrolaPakowania.Shared.DTOs.Requests
@using KontrolaPakowania.Shared.Enums
@using KontrolaPakowania.Shared.Helpers

@page "/kontrola-pakowania/{jl}"
@layout NoNavLayout
@inherits ProtectedPageBase
@implements IDisposable

@inject IJSRuntime JSRuntime
@inject PackingService PackingService
@inject WorkstationService WorkstationService
@inject UserSessionService UserSession
@inject AuthService AuthService
@inject ShipmentService ShipmentService
@inject ClientPrinterService ClientPrinterService;

<div class="container-fluid d-flex flex-column vh-100 p-3 pack-control">
    <div class="d-flex align-items-center mb-3 header-row w-100">

        @if (JlItems != null && JlItems.Any() && Country != "PL")
        {
            <div class="header-image-placeholder me-2">
                <img src="images/exp.jpg" alt="Export" />
            </div>
        }

        @if (CurrentJl != null && CurrentJl.Courier != Courier.Unknown)
        {
            <div class="header-image-placeholder me-3">
                <img src="@Utils.GetCourierSrc(CurrentJl.LogoCourier)" alt="@CurrentJl.LogoCourier" />
            </div>
        }

        <!-- Left section -->
        <div class="me-3">
            <h4>Operator: @Username</h4>
        </div>

        <!-- Center section -->
        <div class="flex-grow-1 text-center">
            <h2 class="scan-blink">Zeskanuj Towar</h2>
        </div>
        <!-- Right section -->
        <div class="d-flex align-items-center ms-auto">
            @if (CurrentJl != null)
            {
                <h4 class="me-3">Klient: @CurrentJl.ClientName</h4>
            }
            <ManagerControlModal OnButtonClick="HandleManagerClick"
                                OnRequestPassword="OnManagerButtonClick"
                                ShowPackingButtons="true"
                                @ref="ManagerModal" />
        </div>
    </div>


    <!-- Full-width input -->
    <div class="mb-3 flex-shrink-0">
        <input type="text" @ref="itemInputRef" @onkeydown="HandleCodeInput" class="form-control form-control-lg" placeholder="Skanuj kod..." />
    </div>

    <!-- Tables row -->
    <div class="row g-3 flex-grow-1">

        <!-- Left table -->
        <div class="col-12 col-lg-8 d-flex flex-column">
            <div class="card shadow-sm flex-grow-1 d-flex flex-column">
                <div class="card-header d-flex justify-content-between">
                    <span>Do spakowania</span>
                    <span>
                        Waga: @(JlItems != null && JlItems.Any()
                                                ? JlItems.Sum(w => w.Weight * w.JlQuantity).ToString("F2")
                                                : "0") kg
                    </span>
                </div>
                <div class="table-responsive flex-grow-1 overflow-auto">
                    <table class="table custom-striped table-hover align-middle mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Kod</th>
                                <th>Ilość</th>
                                <th>Nazwa</th>
                                <th>Obraz</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (JlItems == null)
                            {
                                <tr><td colspan="4" class="text-center">Ładowanie...</td></tr>
                            }
                            else if (!JlItems.Any())
                            {
                                <tr><td colspan="4" class="text-center text-muted">Brak danych</td></tr>
                            }
                            else
                            {
                                @foreach (var item in JlItems)
                                {
                                    var rowClass = HighlightedRows.Contains(item.Code) ? "table-warning" : "";

                                    <tr class="@rowClass clickable-row" @ondblclick="() => OpenProductModal(item)">
                                        <td>@item.Code</td>
                                        <td>@item.JlQuantity</td>
                                        <td>@item.Name</td>
                                        <td>
                                            <img src="@Utils.GetImageSrc(item.Image)" class="jl-item-img rounded" />
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Right table -->
        <div class="col-12 col-lg-4 d-flex flex-column">
            <div class="card shadow-sm flex-grow-1 d-flex flex-column">
                <div class="card-header d-flex justify-content-between">
                    <span>Spakowane</span>
                    <span>
                        Waga: @(PackedItems.Any()
                                                ? PackedItems.Sum(w => w.Weight * w.JlQuantity).ToString("F2")
                                                : "0") kg
                    </span>
                </div>
                <div class="table-responsive flex-grow-1 overflow-auto">
                    <table class="table custom-striped table-hover align-middle mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Kod</th>
                                <th>Ilość</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (!PackedItems.Any())
                            {
                                <tr><td colspan="2" class="text-center text-muted">Jeszcze nic nie spakowano</td></tr>
                            }
                            else
                            {
                                @foreach (var packed in PackedItems)
                                {
                                    var isSelected = packed == SelectedPackedItem ? "table-danger" : "";
                                    <tr class="@isSelected" @onclick="() => SelectPackedItem(packed)">
                                        <td>@packed.Code</td>
                                        <td>@packed.JlQuantity</td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- Buttons at the bottom -->
    <div class="row g-2 mt-3 flex-shrink-0">
        <div class="col-6 col-md">
            <button class="btn btn-warning w-100 h-100 py-4 fs-5">Następny karton/paczka</button>
        </div>
        @if (Settings != null && Settings.PackingLevel == PackingLevel.Dół)
        {
            <div class="col-6 col-md">
                <button class="btn btn-warning w-100 h-100 py-4 fs-5">Bufor</button>
            </div>
        }
        <div class="col-6 col-md">
            <button class="btn btn-danger w-100 h-100 py-4 fs-5" @onclick="MoveBackToLeft">Usuń pozycję</button>
        </div>
        <div class="col-6 col-md">
            <button class="btn btn-danger w-100 h-100 py-4 fs-5" @onclick="Close" disabled="@(PackedItems.Any())">Zamknij</button>
        </div>
        <div class="col-6 col-md">
            <button class="btn btn-success w-100 h-100 py-4 fs-5" @onclick="FinishPacking">Zakończ</button>
        </div>
    </div>

</div>

@if (ShowProductModal && SelectedItem != null)
{
    <ProductSelectModal Product="SelectedItem"
                        OnConfirm="MoveToRight"
                        OnClose="() => ShowProductModal = false" />
}




<PasswordModal @ref=PackingRequirementsModal OnConfirm ="HandlePasswordConfirm" OnCancel="HandlePasswordCancel" />
<PasswordModal @ref=ManagerPasswordModal OnConfirm="HandlePasswordConfirm" />
<CourierModal @ref="CourierModal" />
<LoggedOperatorsModal @ref="LoggedOperatorsModal" />
<JlInProgressModal @ref="JlInProgressModal" />
<PackingJlItemsModal @ref="PackingJlItemsModal" />
<ChangePackingWarehouseModal @ref="ChangePackingWarehouseModal" />
<TextBoxModal @ref="TextBoxModal" />

<ConfirmDialog @ref="confirmDialog"
              Title="Zamknij"
              Message="Czy na pewno chcesz zamknąć?"
              OnCancelClicked="HideConfirm"
              OnConfirmClicked="ConfirmClose" />

<FinishPackingModal @ref="FinishPackingModal"
            CourierSrc="@Utils.GetCourierSrc(CurrentJl.LogoCourier)"
            OnCourierLabel="HandleCourierLabel"
            OnInternalBarcode="HandleInternalBarcode" />

<ShipmentModal @ref="ShipmentModal" />

<Toast @ref="ToastError" Title="Error" Color="danger" />

@code {
    [Parameter] public string Jl { get; set; } = string.Empty;

    private JlDto CurrentJl = new();
    private List<JlItemDto> JlItems = new();
    private List<JlItemDto> PackedItems = new();
    private WorkstationSettings Settings = new();
    private HashSet<string> HighlightedRows = new();
    private ElementReference itemInputRef;
    private string Username = string.Empty;
    private string Country = string.Empty;
    private int PackageId;

    private Toast ToastError = new();
    private PasswordModal ManagerPasswordModal = new();
    private PasswordModal PackingRequirementsModal = new();
    private ConfirmDialog confirmDialog = new();
    private ManagerControlModal ManagerModal = new();
    private TextBoxModal TextBoxModal = new();
    private CourierModal CourierModal = new();
    private LoggedOperatorsModal LoggedOperatorsModal = new();
    private JlInProgressModal JlInProgressModal = new();
    private PackingJlItemsModal PackingJlItemsModal = new();
    private ChangePackingWarehouseModal ChangePackingWarehouseModal = new();
    private FinishPackingModal FinishPackingModal = new();
    private ShipmentModal ShipmentModal = new();

    private bool ShowProductModal = false;
    private PasswordPurpose CurrentPasswordPurpose = PasswordPurpose.None;

    private JlItemDto? SelectedItem;
    private JlItemDto? SelectedPackedItem;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadData();
            await AddJlRealization();
            await CreatePackage();
            ShowPackingRequirements();
            Navigation.LocationChanged += OnLocationChanged;
        }
        catch (Exception ex)
        {
            await ToastError.Show($"Błąd przy inicjalizacji: {ex.Message}");
            await Task.Delay(7000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("blazorFocus.focusElementRef", itemInputRef);
        }
    }

    private async Task LoadData()
    {
        try
        {
            Settings = await WorkstationService.GetSettingsAsync();
            Username = UserSession.Username;
            JlItems = await PackingService.GetJlItems(Jl, Settings.PackingLevel);
            CurrentJl = await PackingService.GetJlInfoByCode(Jl, Settings.PackingLevel);
            Country = JlItems.FirstOrDefault()!.Country;
        }
        catch (Exception ex)
        {
            JlItems = new List<JlItemDto>();

            await ToastError.Show( $"Błąd przy próbie pobrania zawartości kuwety: {ex.Message}");
            await Task.Delay(7000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
        }
        StateHasChanged();
    }

    private async Task AddJlRealization()
    {
        try
        {
            JlInProgressDto jlRealization = new JlInProgressDto
            {
                Name = CurrentJl.Name,
                Courier = CurrentJl.CourierName,
                ClientName = CurrentJl.ClientName,
                StationNumber = Settings.StationNumber,
                Date = DateTime.Now,
                User = UserSession.Username
            };

            await PackingService.AddJlRealization(jlRealization);
        }
        catch (Exception ex)
        {
            JlItems = new List<JlItemDto>();

            await ToastError.Show($"Błąd przy próbie dodania realizacji JL: {ex.Message}");
            await Task.Delay(7000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
        }
        StateHasChanged();
    }

    private async Task CreatePackage()
    {
        try
        {
            CreatePackageRequest packageRequest = new CreatePackageRequest
            {
                ClientAddressId = CurrentJl.ClientAddressId,
                ClientId = CurrentJl.ClientId,
                Username = UserSession.Username,
                Courier = CurrentJl.Courier,
                PackageWarehouse = Settings.PackingWarehouse,
                PackingLevel = Settings.PackingLevel,
                StationNumber = Settings.StationNumber
            };

            var packageId = await PackingService.CreatePackage(packageRequest);
            if (packageId > 0)
            {
                PackageId = packageId;
            }
            else
            {
                await ToastError.Show("Nie udało się utworzyć dokumentu pakowania. Spróbuj ponownie.");
                await Task.Delay(7000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
            }
        }
        catch (Exception ex)
        {
            JlItems = new List<JlItemDto>();

            await ToastError.Show($"Błąd przy próbie stworzenia dokumentu paczki: {ex.Message}");
            await Task.Delay(7000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
        }
        StateHasChanged();
    }

    private void ShowPackingRequirements()
    {
        if (!string.IsNullOrEmpty(CurrentJl.PackingRequirements))
        {
            CurrentPasswordPurpose = PasswordPurpose.PackingRequirementAction;
            PackingRequirementsModal.Show("Wytyczne do pakowania", CurrentJl.PackingRequirements);
        }
    }

    private void OpenProductModal(JlItemDto item)
    {
        SelectedItem = item;
        ShowProductModal = true;
    }

    private async void MoveToRight(decimal qty)
    {
        try
        {
            if (SelectedItem == null || JlItems == null) return;

            AddPackedPositionRequest request = new AddPackedPositionRequest
            {
                PackingDocumentId = PackageId,
                SourceDocumentId = SelectedItem.DocumentId,
                SourceDocumentType = SelectedItem.DocumentType,
                PositionNumber = SelectedItem.PositionNumber,
                Quantity = qty,
                Weight = SelectedItem.Weight,
                Volume = SelectedItem.Volume
            };

            var success = await PackingService.AddPackedPosition(request);
            if (!success)
            {
                await ToastError.Show("Nie udało się dodać spakowanej pozycji. Spróbuj ponownie.");
                await Task.Delay(7000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
                return;
            }

            if (qty == SelectedItem.DocumentQuantity)
            {
                // Full quantity selected -> move whole product
                PackedItems.Add(SelectedItem);
                JlItems.Remove(SelectedItem);
            }
            else
            {
                // Partial quantity selected -> highlight row and move only part
                var existingPacked = PackedItems.FirstOrDefault(p => p.Code == SelectedItem.Code);
                HighlightedRows.Add(SelectedItem.Code);

                if (existingPacked != null)
                {
                    existingPacked.JlQuantity += qty;
                }
                else
                {
                    PackedItems.Add(new JlItemDto
                        {
                            Id = SelectedItem.Id,
                            Code = SelectedItem.Code,
                            Name = SelectedItem.Name,
                            SupplierCode = SelectedItem.SupplierCode,
                            DocumentQuantity = SelectedItem.DocumentQuantity,
                            JlQuantity = qty,
                            Weight = SelectedItem.Weight,
                            Image = SelectedItem.Image,
                            ProductType = SelectedItem.ProductType,
                            Country = SelectedItem.Country,
                            Unit = SelectedItem.Unit,
                            DocumentId = SelectedItem.DocumentId,
                            JlCode = SelectedItem.JlCode
                        });
                }

                // Reduce quantity left in left table
                SelectedItem.JlQuantity -= qty;

                if (SelectedItem.JlQuantity <= 0)
                {
                    JlItems.Remove(SelectedItem);
                }
            }
        }
        catch (Exception ex)
        {
            await ToastError.Show($"Błąd przy próbie spakowania towaru: {ex.Message}");
            await Task.Delay(7000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
        }
        finally
        {

            ShowProductModal = false;
            SelectedItem = null;
            await JSRuntime.InvokeVoidAsync("blazorFocus.focusElementRef", itemInputRef);
            await InvokeAsync(StateHasChanged);
        }
    }

    private async void MoveBackToLeft()
    {
        try
        {
            if (SelectedPackedItem == null) return;


            RemovePackedPositionRequest request = new RemovePackedPositionRequest
            {
                PackingDocumentId = PackageId,
                SourceDocumentId = SelectedPackedItem.DocumentId,
                SourceDocumentType = SelectedPackedItem.DocumentType,
                PositionNumber = SelectedPackedItem.PositionNumber,
                Quantity = SelectedPackedItem.JlQuantity,
                Weight = SelectedPackedItem.Weight,
                Volume = SelectedPackedItem.Volume
            };

            var success = await PackingService.RemovePackedPosition(request);
            if (!success)
            {
                await ToastError.Show("Nie udało się usunąć spakowanej pozycji. Spróbuj ponownie.");
                await Task.Delay(7000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
                return;
            }

            // Find if the item already exists in left list
            var existingLeft = JlItems.FirstOrDefault(j => j.Code == SelectedPackedItem.Code);

            if (existingLeft != null)
            {
                // Add quantity back to existing item
                existingLeft.JlQuantity += SelectedPackedItem.JlQuantity;
            }
            else
            {
                // Recreate the item in left list
                JlItems.Add(SelectedPackedItem);
            }

            // Remove from right
            PackedItems.Remove(SelectedPackedItem);

            // Remove highlight if no longer partially packed
            HighlightedRows.Remove(SelectedPackedItem.Code);

            SelectedPackedItem = null;
        }
        catch (Exception ex)
        {
            await ToastError.Show($"Błąd przy próbie usunięcia towaru: {ex.Message}");
        }
        finally
        {
            await JSRuntime.InvokeVoidAsync("blazorFocus.focusElementRef", itemInputRef);
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task MoveAllToRight()
    {
        try
        {
            if (JlItems == null || !JlItems.Any()) return;

            foreach (var item in JlItems.ToList())
            {
                var existingPacked = PackedItems.FirstOrDefault(p => p.Code == item.Code);

                if (existingPacked != null)
                {
                    existingPacked.JlQuantity += item.JlQuantity;
                }
                else
                {
                    PackedItems.Add(new JlItemDto
                    {
                        Id = item.Id,
                        Code = item.Code,
                        Name = item.Name,
                        SupplierCode = item.SupplierCode,
                        DocumentQuantity = item.DocumentQuantity,
                        JlQuantity = item.JlQuantity,
                        Weight = item.Weight,
                        Image = item.Image,
                        ProductType = item.ProductType,
                        Country = item.Country,
                        Unit = item.Unit,
                        DocumentId = item.DocumentId,
                        JlCode = item.JlCode
                    });
                }

                JlItems.Remove(item);
            }
        }
        catch (Exception ex)
        {
            await ToastError.Show($"Błąd przy próbie spakowania towaru: {ex.Message}");
            await Task.Delay(7000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
        }
        finally
        {
            ShowProductModal = false;
            SelectedItem = null;
            await JSRuntime.InvokeVoidAsync("blazorFocus.focusElementRef", itemInputRef);
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task HandleCodeInput(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            try
            {
                var code = await JSRuntime.InvokeAsync<string>("blazorFocus.getValue", itemInputRef);
                if (!string.IsNullOrEmpty(code) && JlItems != null)
                {
                    // Search by code, barcode, or supplier code
                    var item = JlItems.FirstOrDefault(x =>
                        string.Equals(x.Code, code, StringComparison.OrdinalIgnoreCase) ||
                        string.Equals(x.SupplierCode, code, StringComparison.OrdinalIgnoreCase) ||
                        string.Equals(x.Name, code, StringComparison.OrdinalIgnoreCase));

                    if (item != null)
                    {
                        OpenProductModal(item);
                    }
                }
            }
            catch (Exception ex)
            {
                await ToastError.Show($"Błąd przy próbie zaczytania towaru: {ex.Message}");
                await Task.Delay(7000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
            }
            finally
            {
                await JSRuntime.InvokeVoidAsync("blazorFocus.clearValue", itemInputRef);
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private void SelectPackedItem(JlItemDto packed)
    {
        SelectedPackedItem = packed;
    }

    private void Close()
    {
        confirmDialog.Show = true;
        StateHasChanged();
    }

    private void HideConfirm()
    {
        confirmDialog.Show = false;
    }

    private async void ConfirmClose()
    {
        try
        {
            confirmDialog.Show = false;
            await PackingService.RemoveJlRealization(CurrentJl.Name);
            ClosePackageRequest closePackageRequest = new()
            {
                DocumentId = PackageId,
                Status = DocumentStatus.Delete
            };
            await PackingService.ClosePackage(closePackageRequest);
            Navigation.NavigateTo("/kontrola-pakowania");
        }
        catch (Exception ex)
        {
            await ToastError.Show($"Błąd przy próbie zamknięcia pakowania: {ex.Message}");
            await Task.Delay(8000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
        }
    }

    private async Task HandlePasswordConfirm(string password)
    {
        bool valid = await AuthService.ValidatePasswordAsync(password);
        if (!valid)
        {
            await ToastError.Show("Błędne hasło");
            await Task.Delay(4000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
            return;
        }

        switch (CurrentPasswordPurpose)
        {
            case PasswordPurpose.ManagerAction:
                await ManagerPasswordModal.Close();
                ManagerModal.OpenModal();
                break;
            case PasswordPurpose.PackingRequirementAction:
                await PackingRequirementsModal.Close();
                break;
        }

        CurrentPasswordPurpose = PasswordPurpose.None;
    }

    private void HandlePasswordCancel()
    {
        Navigation.NavigateTo("/kontrola-pakowania");
    }

    private async Task OnManagerButtonClick()
    {
        CurrentPasswordPurpose = PasswordPurpose.ManagerAction;
        await ManagerPasswordModal.Show();
        StateHasChanged();
    }

    private async void HandleManagerClick(int returnClick)
    {
        switch (returnClick)
        {
            case 1: /* Etykiety */ break;
            case 2: /* Spakuj */ 
                await MoveAllToRight();
                break;
            case 3: /* Zawartość */
                var barcode = await TextBoxModal.Show("Zawartość kuwety", "Wprowadź kod wewnętrzny", "Kod wewnętrzny");
                if (!string.IsNullOrEmpty(barcode))
                {
                    await PackingJlItemsModal.ShowModal(barcode);
                }
                break;
            case 4: /* Kurier */
                try
                {
                    if (Country != "PL")
                    {
                        await ToastError.Show("Nie można zmienić kuriera na export!");
                        await Task.Delay(4000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
                        return;
                    }

                    if (CurrentJl.CourierServices.Saturday || CurrentJl.CourierServices._12 || CurrentJl.CourierServices.Return || CurrentJl.CourierServices.Dropshipping)
                    {
                        await ToastError.Show($"Przesyłka z dodatkową usługą (Sobota, Zwrotna, 12:00 lub Dropshipping). Nie możesz zmienić kuriera. Nadaj numer wewnętrzny lub wyślij bieżącym kurierem");
                        await Task.Delay(6000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
                        return;
                    }

                    var selectedCourier = await CourierModal.ShowModal(CurrentJl.Courier);
                    if (selectedCourier.HasValue && selectedCourier.Value != Courier.Unknown)
                    {
                        UpdatePackageCourierRequest updateRequest = new UpdatePackageCourierRequest
                            {
                                PackageId = PackageId,
                                Courier = selectedCourier.Value
                            };

                        var success = await PackingService.UpdatePackageCourier(updateRequest);
                        if (!success)
                        {
                            await ToastError.Show("Nie udało się zmienić kuriera. Spróbuj ponownie.");
                            await Task.Delay(5000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
                            return;
                        }

                        CurrentJl.Courier = selectedCourier.Value;
                        CurrentJl.InitCourierLogo();
                        await InvokeAsync(StateHasChanged);
                    }
                }
                catch (Exception ex)
                {
                    await ToastError.Show($"Błąd przy próbie zmiany kuriera: {ex.Message}");
                    await Task.Delay(6000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
                }
                break;
            case 5: /* Zalogowani */ 
                await LoggedOperatorsModal.ShowModal();
                break;
            case 6: /* Kuwety podjęte */
                await JlInProgressModal.ShowModal();
                break;
            case 7: /* Zwolnij */
                try
                {
                    var jlCode = await TextBoxModal.Show("Zwolnij kuwetę", "Wprowadź kod kuwety", "Kod kuwety");
                    if (!string.IsNullOrEmpty(jlCode))
                    {
                        var releaseSuccess = await PackingService.ReleaseJl(jlCode);
                        if (!releaseSuccess)
                        {
                            await ToastError.Show("Kuweta nie została zwolniona. Spróbuj ponownie.");
                            await Task.Delay(6000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
                            return;
                        }
                    }
                }
                catch (Exception ex)
                {
                    await ToastError.Show($"Błąd przy próbie zwolnienia kuwety: {ex.Message}");
                    await Task.Delay(6000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
                }
                break;
            case 8: /* Zmień magazyn */
                await ChangePackingWarehouseModal.Show();
                break;
        }
    }

    private async Task FinishPacking()
    {
        try
        {
            if (!PackedItems.Any())
            {
                await ToastError.Show("Brak spakowanych towarów!");
                await Task.Delay(6000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
                return;
            }

            FinishPackingModal.Show();
        }
        catch (Exception ex)
        {
            await ToastError.Show($"Błąd przy próbie finalizacji pakowania: {ex.Message}");
            await Task.Delay(8000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
        }
    }

    private async Task ClosePackage(string internalBarcode)
    {
        if (!CurrentJl.PackageClosed)
        {
            ClosePackageRequest closeRequest = new ClosePackageRequest
            {
                DocumentId = PackageId,
                InternalBarcode = internalBarcode,
                Status = DocumentStatus.Ready 
            };

            var success = await PackingService.ClosePackage(closeRequest);
            if (!success)
            {
                await ToastError.Show("Nie udało się zamknąć dokumentu pakowania. Spróbuj ponownie.");
                await Task.Delay(6000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
                return;
            }

            CurrentJl.PackageClosed = true;
        }
    }

    private async Task HandleCourierLabel()
    {
        try
        {
            string internalBarcode = await PackingService.GenerateInternalBarcode(Settings.StationNumber);
            if (string.IsNullOrEmpty(internalBarcode))
            {
                await ToastError.Show("Nie udało się wygenerować numeru wewnętrznego. Spróbuj ponownie.");
                await Task.Delay(6000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
                return;
            }

            await ClosePackage(internalBarcode);

            // Shipment
            ShipmentRequest shipmentRequest = new ShipmentRequest
            {
                PackageId = PackageId,
                Courier = CurrentJl.Courier,
            };

            var response = await ShipmentService.SendPackage(shipmentRequest);



            if (response?.PackageId > 0)
            {
                if (!string.IsNullOrEmpty(response.LabelBase64))
                {
                    var labelContent = response.LabelBase64;
                    await ClientPrinterService.PrintAsync(Settings.PrinterLabel, response.LabelType.ToString(), labelContent);
                    ShipmentModal.Show(response.TrackingNumber, response.LabelBase64, response.LabelType, Settings.PrinterLabel);
                }
                else
                {
                    await ToastError.Show("Nie udało się wygenerować etykiety kurierskiej!");
                    await Task.Delay(6000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
                }
            }
            else
            {
                await ToastError.Show("Nie udało się wygenerować przesyłki!");
                await Task.Delay(6000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
            }
        }
        catch (Exception ex)
        {
            await ToastError.Show($"Błąd przy próbie finalizacji pakowania: {ex.Message}");
            await Task.Delay(8000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
        }
    }

    private async Task HandleInternalBarcode()
    {
        try
        {
            string internalBarcode = await TextBoxModal.Show("Numer wewnętrzny", "Wprowadź numer wewnętrzny", "Kod kreskowy");
            if (string.IsNullOrEmpty(internalBarcode)) return;

            await ClosePackage(internalBarcode);
            Navigation.NavigateTo("/kontrola-pakowania");
        }
        catch (Exception ex)
        {
            await ToastError.Show($"Błąd przy próbie finalizacji pakowania: {ex.Message}");
            await Task.Delay(8000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
        }
    }

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        var uri = Navigation.ToBaseRelativePath(Navigation.Uri); // removes domain
        if (!uri.StartsWith("kontrola-pakowania/", StringComparison.OrdinalIgnoreCase))
        {
            await PackingService.RemoveJlRealization(CurrentJl.Name);
        }
        await PackingService.RemoveJlRealization(CurrentJl.Name);
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}
