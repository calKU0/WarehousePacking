@using KontrolaPakowania.Shared.DTOs.Requests
@using KontrolaPakowania.Shared.Enums
@using KontrolaPakowania.Shared.Helpers

@page "/kontrola-pakowania/{jl}"
@layout NoNavLayout
@inherits ProtectedPageBase
@implements IDisposable

@inject IJSRuntime JSRuntime
@inject PackingService PackingService
@inject WorkstationService WorkstationService
@inject UserSessionService UserSession
@inject AuthService AuthService
@inject ShipmentService ShipmentService
@inject ClientPrinterService ClientPrinterService;

<div class="container-fluid d-flex flex-column vh-100 p-3 pack-control">
    <div class="d-flex align-items-center mb-3 header-row w-100">

        @if (JlItems != null && JlItems.Any() && CurrentJl.Country != "PL")
        {
            <div class="header-image-placeholder me-2">
                <img src="images/exp.jpg" alt="Export" />
            </div>
        }

        @if (CurrentJl != null && CurrentJl.Courier != Courier.Unknown)
        {
            <div class="header-image-placeholder me-3">
                <img src="@Utils.GetCourierSrc(CurrentJl.LogoCourier)" alt="@CurrentJl.LogoCourier" />
            </div>
        }

        <!-- Left section -->
        <div class="me-3">
            <h4>Operator: @UserSession.Username</h4>
        </div>

        <!-- Center section -->
        <div class="flex-grow-1 text-center">
            <h2 class="scan-blink">Zeskanuj Towar</h2>
        </div>
        <!-- Right section -->
        <div class="d-flex align-items-center ms-auto">
            @if (CurrentJl != null)
            {
                <h4 class="me-3">Klient: @CurrentJl.ClientName</h4>
            }
            <ManagerControlModal OnButtonClick="HandleManagerClick"
                                OnRequestPassword="OnManagerButtonClick"
                                ShowPackingButtons="true"
                                @ref="ManagerModal" />
        </div>
    </div>


    <!-- Full-width input -->
    <div class="mb-3 flex-shrink-0">
        <input type="text" @ref="itemInputRef" @onkeydown="HandleCodeInput" class="form-control form-control-lg" placeholder="Skanuj kod..." />
    </div>

    <!-- Tables row -->
    <div class="row g-3 flex-grow-1">

        <!-- Left table -->
        <div class="col-12 col-lg-8 d-flex flex-column">
            <div class="card shadow-sm flex-grow-1 d-flex flex-column">
                <div class="card-header d-flex justify-content-between">
                    <span>Do spakowania</span>
                    <span>
                        Waga: @(JlItems != null && JlItems.Any()
                                                ? JlItems.Sum(w => w.Weight * w.JlQuantity).ToString("F2")
                                                : "0") kg
                    </span>
                </div>
                <div class="table-responsive flex-grow-1 overflow-auto">
                    <table class="table custom-striped table-hover align-middle mb-0 table-tall">
                        <thead class="table-dark">
                            <tr>
                                <th>Kod</th>
                                <th>Ilość</th>
                                <th>Nazwa</th>
                                <th>Obraz</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (JlItems == null)
                            {
                                <tr><td colspan="4" class="text-center">Ładowanie...</td></tr>
                            }
                            else if (!JlItems.Any())
                            {
                                <tr><td colspan="4" class="text-center text-muted">Brak danych</td></tr>
                            }
                            else
                            {
                                @foreach (var item in JlItems)
                                {
                                    var rowClass = HighlightedRows.Contains(item.Code) ? "table-warning" : "";

                                    <tr class="@rowClass clickable-row" @ondblclick="() => OpenProductModal(item)">
                                        <td>@item.Code</td>
                                        <td>@item.JlQuantity</td>
                                        <td>@item.Name</td>
                                        <td>
                                            <img src="@Utils.GetImageSrc(item.Image)" class="jl-item-img rounded" />
                                        </td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Right table -->
        <div class="col-12 col-lg-4 d-flex flex-column">
            <div class="card shadow-sm flex-grow-1 d-flex flex-column">
                <div class="card-header d-flex justify-content-between">
                    <span>Spakowane</span>
                    <span>
                        Waga: @(PackedItems.Any()
                                                ? PackedItems.Sum(w => w.Weight * w.JlQuantity).ToString("F2")
                                                : "0") / @(CourierConfiguration.MaxPackageWeight.ToString("F2")) kg
                    </span>
                </div>
                <div class="table-responsive flex-grow-1 overflow-auto">
                    <table class="table custom-striped table-hover align-middle mb-0 table-tall">
                        <thead class="table-dark">
                            <tr>
                                <th>Kod</th>
                                <th>Ilość</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (!PackedItems.Any())
                            {
                                <tr><td colspan="2" class="text-center text-muted">Jeszcze nic nie spakowano</td></tr>
                            }
                            else
                            {
                                @foreach (var packed in PackedItems)
                                {
                                    var isSelected = packed == SelectedPackedItem ? "table-danger" : "";
                                    <tr class="@isSelected" @onclick="() => SelectPackedItem(packed)">
                                        <td>@packed.Code</td>
                                        <td>@packed.JlQuantity</td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <!-- Buttons at the bottom -->
    <div class="row g-2 mt-3 flex-shrink-0">
        <div class="col-6 col-md">
            <button class="btn btn-warning w-100 h-100 py-4 fs-5" @onclick="NextPackage">Następna paczka</button>
        </div>
        @if (Settings != null && Settings.PackingLevel == PackingLevel.Dół)
        {
            <div class="col-6 col-md">
                <button class="btn btn-warning w-100 h-100 py-4 fs-5" @onclick="Bufor">Bufor</button>
            </div>
        }
        <div class="col-6 col-md">
            <button class="btn btn-danger w-100 h-100 py-4 fs-5" @onclick="UnpackItem">Usuń pozycję</button>
        </div>
        <div class="col-6 col-md">
            <button class="btn btn-danger w-100 h-100 py-4 fs-5" @onclick="Close" disabled="@(PackedItems.Any())">Zamknij</button>
        </div>
        <div class="col-6 col-md">
            <button class="btn btn-success w-100 h-100 py-4 fs-5" @onclick="FinishPacking">Zakończ</button>
        </div>
    </div>

</div>

@if (ShowProductModal && SelectedItem != null)
{
    <ProductSelectModal Product="SelectedItem"
                        OnConfirm="PackItem"
                        OnClose="() => ShowProductModal = false" />
}

<PasswordModal @ref=PackingRequirementsModal OnConfirm ="HandlePasswordConfirm" OnCancel="HandlePasswordCancel" />
<PasswordModal @ref=ManagerPasswordModal OnConfirm="HandlePasswordConfirm" />
<ConfirmDialog @ref="ConfirmDialog" OnCancelClicked="HideConfirm" OnConfirmClicked="ConfirmClose" />
<CourierModal @ref="CourierModal" />
<LoggedOperatorsModal @ref="LoggedOperatorsModal" />
<JlInProgressModal @ref="JlInProgressModal" />
<PackingJlItemsModal @ref="PackingJlItemsModal" />
<ChangePackingWarehouseModal @ref="ChangePackingWarehouseModal" />
<TextBoxModal @ref="TextBoxModal" />

<FinishPackingModal @ref="FinishPackingModal"
            Courier="CurrentJl.Courier"
            CourierSrc="@Utils.GetCourierSrc(CurrentJl.LogoCourier)"
            OnCourierLabel="HandleCourierLabel"
            OnInternalBarcode="HandleInternalBarcode" />

<DimensionsModal @ref="DimensionsModal"  />
<ShipmentModal @ref="ShipmentModal" OnOk="HandleShipmentOkClick" />

<Toast @ref="Toast" />

@code {
    [Parameter] public string Jl { get; set; } = string.Empty;

    private JlDto CurrentJl = new();
    private List<string> MergeJlsName = new();
    private List<JlItemDto> JlItems = new();
    private List<JlItemDto> PackedItems = new();
    private WorkstationSettings Settings = new();
    private CourierConfiguration CourierConfiguration = new();
    private HashSet<string> HighlightedRows = new();
    private ElementReference itemInputRef;
    private int PackageId;

    private Toast Toast = new();
    private PasswordModal ManagerPasswordModal = new();
    private PasswordModal PackingRequirementsModal = new();
    private ConfirmDialog ConfirmDialog = new();
    private ManagerControlModal ManagerModal = new();
    private TextBoxModal TextBoxModal = new();
    private CourierModal CourierModal = new();
    private LoggedOperatorsModal LoggedOperatorsModal = new();
    private JlInProgressModal JlInProgressModal = new();
    private PackingJlItemsModal PackingJlItemsModal = new();
    private ChangePackingWarehouseModal ChangePackingWarehouseModal = new();
    private DimensionsModal DimensionsModal = new();
    private FinishPackingModal FinishPackingModal = new();
    private ShipmentModal ShipmentModal = new();

    private bool ShowProductModal = false;
    private PasswordPurpose CurrentPasswordPurpose = PasswordPurpose.None;
    private PackingFlow _currentPackingFlow;

    private JlItemDto? SelectedItem;
    private JlItemDto? SelectedPackedItem;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await UserSession.InitializeAsync();
            await LoadSettings();
            await LoadMergeJlsFromQuery();
            await LoadJlData();
            await LoadCourierConfiguration();
            await AddJlRealizations();
            await CreatePackage();
            await ShowPackingRequirements();

            Navigation.LocationChanged += OnLocationChanged;
        }
        catch (Exception ex)
        {
            Toast.Show("Błąd!", $"Błąd przy inicjalizacji: {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("blazorFocus.focusElementRef", itemInputRef);
        }
    }

    private async Task LoadSettings()
    {
        try
        {
            Settings = await WorkstationService.GetSettingsAsync();
        }
        catch (Exception ex)
        {
            Toast.Show("Błąd!", $"Błąd przy próbie pobrania konfiguracji stanowiska: {ex.Message}");
        }
    }

    private async Task LoadCourierConfiguration()
    {
        try
        {
            CourierConfiguration = await PackingService.GetCourierConfiguration(CurrentJl.CourierName, Settings.PackingLevel, CurrentJl.Country);
        }
        catch (Exception ex)
        {
            Toast.Show("Błąd!", $"Błąd przy próbie pobrania konfiguracji kuriera: {ex.Message}");
        }
    }

    private async Task LoadMergeJlsFromQuery()
    {
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);
        if (query.TryGetValue("mergeNames", out var mergeNamesStr))
        {
            MergeJlsName = mergeNamesStr.ToString().Split(',', StringSplitOptions.RemoveEmptyEntries).ToList();
        }
    }

    private async Task LoadJlData()
    {
        try
        {
            CurrentJl = await PackingService.GetJlInfoByCode(Jl, Settings.PackingLevel);
            JlItems = await PackingService.GetJlItems(CurrentJl.Name, Settings.PackingLevel);

            if (MergeJlsName.Any())
            {
                foreach (var jl in MergeJlsName)
                {
                    var items = await PackingService.GetJlItems(jl, Settings.PackingLevel);
                    JlItems.AddRange(items);
                }
            }
        }
        catch (Exception ex)
        {
            JlItems = new List<JlItemDto>();

            Toast.Show("Błąd!", $"Błąd przy próbie pobrania zawartości kuwety: {ex.Message}");
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task AddJlRealizations()
    {
        // Base JL realization
        await PackingService.AddJlRealization(new JlInProgressDto
        {
            Name = CurrentJl.Name,
            Courier = CurrentJl.CourierName,
            ClientName = CurrentJl.ClientName,
            StationNumber = Settings.StationNumber,
            Date = DateTime.Now,
            User = UserSession.Username
        });

        // Additional merged JLs realizations
        foreach (var jl in MergeJlsName)
        {
            await PackingService.AddJlRealization(new JlInProgressDto
            {
                Name = jl,
                Courier = CurrentJl.CourierName,
                ClientName = CurrentJl.ClientName,
                StationNumber = Settings.StationNumber,
                Date = DateTime.Now,
                User = UserSession.Username
            });
        }
    }

    private async Task CreatePackage()
    {
        try
        {
            CreatePackageRequest packageRequest = new CreatePackageRequest
            {
                ClientAddressId = CurrentJl.ClientAddressId,
                ClientAddressType = CurrentJl.ClientAddressType,
                ClientId = CurrentJl.ClientId,
                Username = UserSession.Username,
                Courier = CurrentJl.Courier,
                PackageWarehouse = Settings.PackingWarehouse,
                PackingLevel = Settings.PackingLevel,
                StationNumber = Settings.StationNumber
            };

            var packageId = await PackingService.CreatePackage(packageRequest);
            if (packageId > 0)
            {
                PackageId = packageId;
                CurrentJl.PackageClosed = false;
            }
            else
            {
                Toast.Show("Błąd!", "Nie udało się utworzyć dokumentu pakowania. Spróbuj ponownie.");
            }
        }
        catch (Exception ex)
        {
            JlItems = new List<JlItemDto>();
            Toast.Show("Błąd!", $"Błąd przy próbie stworzenia dokumentu paczki: {ex.Message}");
        }
        StateHasChanged();
    }

    private async Task ShowPackingRequirements()
    {
        // TO DO
        // Focus after closing
        if (!string.IsNullOrEmpty(CurrentJl.PackingRequirements))
        {
            CurrentPasswordPurpose = PasswordPurpose.PackingRequirementAction;
            await PackingRequirementsModal.Show("Wytyczne do pakowania", CurrentJl.PackingRequirements);
        }
    }

    private void OpenProductModal(JlItemDto item)
    {
        SelectedItem = item;
        ShowProductModal = true;
    }

    private async void PackItem(decimal qty)
    {
        try
        {
            if (SelectedItem == null || JlItems == null) return;

            bool moved = await MoveItemToPacked(SelectedItem, qty);
            if (!moved) return;

            // Auto finish packing if nothing left
            if (!JlItems.Any())
            {
                FinishPacking();
            }
        }
        catch (Exception ex)
        {
            Toast.Show("Błąd!", $"Błąd przy próbie spakowania towaru: {ex.Message}");
        }
        finally
        {
            ShowProductModal = false;
            SelectedItem = null;
            await JSRuntime.InvokeVoidAsync("blazorFocus.focusElementRef", itemInputRef);
            await InvokeAsync(StateHasChanged);
        }
    }


    private async Task<bool> MoveItemToPacked(JlItemDto item, decimal qty)
    {
        if (item == null) return false;

        // Check weight limit
        if (CourierHelper.AllowedCouriersForLabel.Contains(CurrentJl.Courier) &&
            PackedItems.Sum(w => w.Weight * w.JlQuantity) + (item.Weight * qty) > CourierConfiguration.MaxPackageWeight)
        {
            Toast.Show("Błąd!", $"Przekroczona waga, zmień ilość. Dopuszczalna waga: {CourierConfiguration.MaxPackageWeight}");
            return false;
        }

        // Add to ERP package
        var request = new AddPackedPositionRequest
        {
            PackingDocumentId = PackageId,
            SourceDocumentId = item.DocumentId,
            SourceDocumentType = item.DocumentType,
            PositionNumber = item.PositionNumber,
            Quantity = qty,
            Weight = item.Weight,
            Volume = item.Volume
        };

        var success = await PackingService.AddPackedPosition(request);
        if (!success)
        {
            Toast.Show("Błąd!", "Nie udało się dodać spakowanej pozycji. Spróbuj ponownie.");
            return false;
        }

        // Move to PackedItems
        var existingPacked = PackedItems.FirstOrDefault(p => p.Code == item.Code);

        if (qty == item.DocumentQuantity || qty == item.JlQuantity)
        {
            // Move entire item
            if (existingPacked == null)
                PackedItems.Add(item);
            else
                existingPacked.JlQuantity += qty;

            JlItems.Remove(item);
        }
        else
        {
            // Partial quantity
            HighlightedRows.Add(item.Code);

            if (existingPacked != null)
                existingPacked.JlQuantity += qty;
            else
                PackedItems.Add(new JlItemDto
                {
                    Id = item.Id,
                    Code = item.Code,
                    Name = item.Name,
                    SupplierCode = item.SupplierCode,
                    DocumentQuantity = item.DocumentQuantity,
                    JlQuantity = qty,
                    Weight = item.Weight,
                    Image = item.Image,
                    ProductType = item.ProductType,
                    Country = item.Country,
                    Unit = item.Unit,
                    DocumentId = item.DocumentId,
                    JlCode = item.JlCode
                });

            item.JlQuantity -= qty;
            if (item.JlQuantity <= 0)
                JlItems.Remove(item);
        }

        return true;
    }

    private async Task PackAllItems()
    {
        try
        {
            if (JlItems == null || !JlItems.Any()) return;

            foreach (var item in JlItems.ToList())
            {
                bool moved = await MoveItemToPacked(item, item.JlQuantity);
                if (!moved) return;
            }

            // Auto finish packing if nothing left
            if (!JlItems.Any())
            {
                FinishPacking();
            }
        }
        catch (Exception ex)
        {
            Toast.Show("Błąd!", $"Błąd przy próbie spakowania wszystkich towarów: {ex.Message}");
        }
        finally
        {
            ShowProductModal = false;
            SelectedItem = null;
            await JSRuntime.InvokeVoidAsync("blazorFocus.focusElementRef", itemInputRef);
            await InvokeAsync(StateHasChanged);
        }
    }

    private async void UnpackItem()
    {
        try
        {
            if (SelectedPackedItem == null) return;

            RemovePackedPositionRequest request = new RemovePackedPositionRequest
            {
                PackingDocumentId = PackageId,
                SourceDocumentId = SelectedPackedItem.DocumentId,
                SourceDocumentType = SelectedPackedItem.DocumentType,
                PositionNumber = SelectedPackedItem.PositionNumber,
                Quantity = SelectedPackedItem.JlQuantity,
                Weight = SelectedPackedItem.Weight,
                Volume = SelectedPackedItem.Volume
            };

            var success = await PackingService.RemovePackedPosition(request);
            if (!success)
            {
                Toast.Show("Błąd!", "Nie udało się usunąć spakowanej pozycji. Spróbuj ponownie.");
                return;
            }

            // Find if the item already exists in left list
            var existingLeft = JlItems.FirstOrDefault(j => j.Code == SelectedPackedItem.Code);

            if (existingLeft != null)
            {
                // Add quantity back to existing item
                existingLeft.JlQuantity += SelectedPackedItem.JlQuantity;
            }
            else
            {
                // Recreate the item in left list
                JlItems.Add(SelectedPackedItem);
            }

            // Remove from right
            PackedItems.Remove(SelectedPackedItem);

            // Remove highlight if no longer partially packed
            HighlightedRows.Remove(SelectedPackedItem.Code);

            SelectedPackedItem = null;
        }
        catch (Exception ex)
        {
            Toast.Show("Błąd!", $"Błąd przy próbie usunięcia towaru: {ex.Message}");
        }
        finally
        {
            await JSRuntime.InvokeVoidAsync("blazorFocus.focusElementRef", itemInputRef);
            await InvokeAsync(StateHasChanged);
        }
    }


    private async Task HandleCodeInput(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            try
            {
                var code = await JSRuntime.InvokeAsync<string>("blazorFocus.getValue", itemInputRef);
                if (!string.IsNullOrEmpty(code) && JlItems != null)
                {
                    // Search by code, barcode, or supplier code
                    var item = JlItems.FirstOrDefault(x =>
                        string.Equals(x.Code, code, StringComparison.OrdinalIgnoreCase) ||
                        string.Equals(x.SupplierCode, code, StringComparison.OrdinalIgnoreCase) ||
                        string.Equals(x.Name, code, StringComparison.OrdinalIgnoreCase));

                    if (item != null)
                    {
                        OpenProductModal(item);
                    }
                }
            }
            catch (Exception ex)
            {
                Toast.Show("Błąd!", $"Błąd przy próbie zaczytania towaru: {ex.Message}");
            }
            finally
            {
                await JSRuntime.InvokeVoidAsync("blazorFocus.clearValue", itemInputRef);
                await InvokeAsync(StateHasChanged);
            }
        }
    }

    private void SelectPackedItem(JlItemDto packed)
    {
        SelectedPackedItem = packed;
    }

    private void Close()
    {
        ConfirmDialog.Show("Wyjście z kuwety", "Czy napewno chcesz wyjść z kuwety?");
    }

    private async Task HideConfirm()
    {
        ConfirmDialog.Hide();
        await JSRuntime.InvokeVoidAsync("blazorFocus.focusElementRef", itemInputRef);
    }

    private async void ConfirmClose()
    {
        try
        {
            ConfirmDialog.Hide();
            await PackingService.RemoveJlRealization(CurrentJl.Name);
            ClosePackageRequest closePackageRequest = new()
            {
                DocumentId = PackageId,
                Status = DocumentStatus.Delete
            };
            await PackingService.ClosePackage(closePackageRequest);
            Navigation.NavigateTo("/kontrola-pakowania");
        }
        catch (Exception ex)
        {
            Toast.Show("Błąd!", $"Błąd przy próbie zamknięcia pakowania: {ex.Message}");
        }
    }

    private async Task HandlePasswordConfirm(string password)
    {
        bool valid = await AuthService.ValidatePasswordAsync(password);
        if (!valid)
        {
            Toast.Show("Błąd!", "Błędne hasło");
            return;
        }

        switch (CurrentPasswordPurpose)
        {
            case PasswordPurpose.ManagerAction:
                await ManagerPasswordModal.Hide();
                ManagerModal.OpenModal();
                break;
            case PasswordPurpose.PackingRequirementAction:
                await PackingRequirementsModal.Hide();
                break;
        }

        CurrentPasswordPurpose = PasswordPurpose.None;
    }

    private void HandlePasswordCancel()
    {
        Navigation.NavigateTo("/kontrola-pakowania");
    }

    private async Task OnManagerButtonClick()
    {
        CurrentPasswordPurpose = PasswordPurpose.ManagerAction;
        await ManagerPasswordModal.Show();
        StateHasChanged();
    }

    private async void HandleManagerClick(int returnClick)
    {
        switch (returnClick)
        {
            case 1: /* Etykiety */ break;
            case 2: /* Spakuj */ 
                await PackAllItems();
                break;
            case 3: /* Zawartość */
                var barcode = await TextBoxModal.Show("Zawartość kuwety", "Wprowadź kod wewnętrzny", "Kod wewnętrzny");
                if (!string.IsNullOrEmpty(barcode))
                {
                    await PackingJlItemsModal.ShowModal(barcode);
                }
                break;
            case 4: /* Kurier */
                try
                {
                    if (CurrentJl.Country != "PL")
                    {
                        Toast.Show("Błąd!", "Nie można zmienić kuriera na export!");
                        return;
                    }

                    if (CurrentJl.ShipmentServices.HasAnyService())
                    {
                        Toast.Show("Błąd!", $"Przesyłka z dodatkową usługą (Sobota, Zwrotna, 12:00 lub Dropshipping). Nie możesz zmienić kuriera. Nadaj numer wewnętrzny lub wyślij bieżącym kurierem");
                        return;
                    }

                    var selectedCourier = await CourierModal.ShowModal(CurrentJl.Courier);
                    if (selectedCourier.HasValue && selectedCourier.Value != Courier.Unknown)
                    {
                        UpdatePackageCourierRequest updateRequest = new UpdatePackageCourierRequest
                        {
                            PackageId = PackageId,
                            Courier = selectedCourier.Value
                        };

                        var success = await PackingService.UpdatePackageCourier(updateRequest);
                        if (!success)
                        {
                            Toast.Show("Błąd!", "Nie udało się zmienić kuriera. Spróbuj ponownie.");
                            return;
                        }
                        CurrentJl.Courier = selectedCourier.Value;
                        await LoadCourierConfiguration();
                        await InvokeAsync(StateHasChanged);
                    }
                }
                catch (Exception ex)
                {
                    Toast.Show("Błąd!", $"Błąd przy próbie zmiany kuriera: {ex.Message}");
                }
                break;
            case 5: /* Zalogowani */ 
                await LoggedOperatorsModal.ShowModal();
                break;
            case 6: /* Kuwety podjęte */
                await JlInProgressModal.ShowModal();
                break;
            case 7: /* Zwolnij */
                try
                {
                    var jlCode = await TextBoxModal.Show("Zwolnij kuwetę", "Wprowadź kod kuwety", "Kod kuwety");
                    if (!string.IsNullOrEmpty(jlCode))
                    {
                        var releaseSuccess = await PackingService.ReleaseJl(jlCode);
                        if (!releaseSuccess)
                        {
                            Toast.Show("Błąd!", "Kuweta nie została zwolniona. Spróbuj ponownie.");
                            return;
                        }
                    }
                }
                catch (Exception ex)
                {
                    Toast.Show("Błąd!", $"Błąd przy próbie zwolnienia kuwety: {ex.Message}");
                }
                break;
            case 8: /* Zmień magazyn */
                await ChangePackingWarehouseModal.Show();
                break;
        }
        await JSRuntime.InvokeVoidAsync("blazorFocus.focusElementRef", itemInputRef);
    }

    private Task Bufor()
    {
        // TODO:
        // Bufor
        throw new NotImplementedException();
    }

    private void FinishPacking()
    {
        _currentPackingFlow = PackingFlow.FinishPacking;
        ShowPackingModal();
    }

    private void NextPackage()
    {
        _currentPackingFlow = PackingFlow.NextPackage;
        ShowPackingModal();
    }

    private void ShowPackingModal()
    {
        try
        {
            if (!PackedItems.Any())
            {
                Toast.Show("Błąd!", "Brak spakowanych towarów!");
                return;
            }

            FinishPackingModal.Show();
        }
        catch (Exception ex)
        {
            Toast.Show("Błąd!", $"Błąd przy próbie finalizacji pakowania: {ex.Message}");
        }
    }


    private async Task ClosePackage(string internalBarcode, Dimensions dimensions)
    {
        if (!CurrentJl.PackageClosed)
        {
            ClosePackageRequest closeRequest = new ClosePackageRequest
            {
                DocumentId = PackageId,
                InternalBarcode = internalBarcode,
                Height = dimensions.Height,
                Width = dimensions.Width,
                Length = dimensions.Length,
                Status = DocumentStatus.Ready
            };

            var success = await PackingService.ClosePackage(closeRequest);
            if (!success)
            {
                Toast.Show("Błąd!", "Nie udało się zamknąć dokumentu pakowania. Spróbuj ponownie.");
                return;
            }

            CurrentJl.PackageClosed = true;
        }
    }

    private async Task HandleCourierLabel()
    {
        try
        {
            FinishPackingModal.Hide();
            string internalBarcode = await PackingService.GenerateInternalBarcode(Settings.StationNumber);
            if (string.IsNullOrEmpty(internalBarcode))
            {
                Toast.Show("Błąd!", "Nie udało się wygenerować numeru wewnętrznego. Spróbuj ponownie.");
                return;
            }

            await ClosePackage(internalBarcode, new Dimensions());

            // Shipment
            var package = await ShipmentService.GetShipmentDataByBarcode(internalBarcode);
            var response = await ShipmentService.SendPackage(package);

            if (response?.PackageId > 0)
            {
                if (!string.IsNullOrEmpty(response.LabelBase64))
                {
                    var labelContent = response.LabelBase64;
                    await ClientPrinterService.PrintAsync(Settings.PrinterLabel, response.LabelType.ToString(), labelContent);
                    ShipmentModal.Show(response.TrackingNumber, response.LabelBase64, response.LabelType, Settings.PrinterLabel, package.HasInvoice);
                    if (package.HasInvoice)
                    {
                        await ClientPrinterService.PrintCrystalAsync(Settings.PrinterInvoice, package.RecipientCountry != "PL" ? "InvoiceEN" : "InvoicePL", new Dictionary<string, string> { { "DocumentId", package.InvoiceId.ToString() } });
                    }
                }
                else
                {
                    var msg = string.IsNullOrWhiteSpace(response.ErrorMessage)
                        ? "Nie udało się wygenerować etykiety kurierskiej!"
                        : response.ErrorMessage;

                    Toast.Show("Błąd!", msg);
                }
            }
            else
            {
                var msg = string.IsNullOrWhiteSpace(response?.ErrorMessage)
                    ? "Nie udało się wygenerować przesyłki!"
                    : response.ErrorMessage;

                Toast.Show("Błąd!", msg);
            }
        }
        catch (Exception ex)
        {
            Toast.Show("Błąd!", $"Błąd przy próbie finalizacji pakowania: {ex.Message}");
        }
    }

    private async Task HandleInternalBarcode()
    {
        try
        {
            FinishPackingModal.Hide();

            string internalBarcode = await TextBoxModal.Show("Numer wewnętrzny", "Wprowadź numer wewnętrzny", "Kod kreskowy");
            if (string.IsNullOrEmpty(internalBarcode)) return;

            Dimensions dimensions = new();
            if (Settings.PackingLevel == PackingLevel.Dół && !CourierHelper.AllowedCouriersForLabel.Contains(CurrentJl.Courier))
            {
                dimensions = await DimensionsModal.Show();
            }

            await ClosePackage(internalBarcode, dimensions);
            await ClientPrinterService.PrintCrystalAsync(Settings.PrinterLabel, "Label", new Dictionary<string, string> { { "Kod Kreskowy", internalBarcode } });

            switch (_currentPackingFlow)
            {
                case PackingFlow.FinishPacking:
                    Navigation.NavigateTo("/kontrola-pakowania");
                    break;
                case PackingFlow.NextPackage:
                    PackedItems.Clear();
                    StateHasChanged();
                    break;
            }
        }
        catch (Exception ex)
        {
            Toast.Show("Błąd!", $"Błąd przy próbie finalizacji pakowania: {ex.Message}");
        }
    }

    private async Task HandleShipmentOkClick()
    {
        switch (_currentPackingFlow)
        {
            case PackingFlow.FinishPacking:
                Navigation.NavigateTo("/kontrola-pakowania");
                break;
            case PackingFlow.NextPackage:
                PackedItems.Clear();
                await CreatePackage();
                StateHasChanged();
                break;
        }
    }

    private async void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        var uri = Navigation.ToBaseRelativePath(Navigation.Uri); // removes domain
        if (!uri.StartsWith("kontrola-pakowania/", StringComparison.OrdinalIgnoreCase))
        {
            await PackingService.RemoveJlRealization(CurrentJl.Name);
        }
        await PackingService.RemoveJlRealization(CurrentJl.Name);
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}
