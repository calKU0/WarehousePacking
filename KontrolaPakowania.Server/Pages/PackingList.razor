@page "/kontrola-pakowania"
@using KontrolaPakowania.Server.Services
@using KontrolaPakowania.Server.Settings
@using KontrolaPakowania.Server.Shared
@using KontrolaPakowania.Shared.DTOs.Requests
@using KontrolaPakowania.Shared.Enums
@using KontrolaPakowania.Shared.Helpers
@using Microsoft.Extensions.Options
@inject PackingService PackingService
@inject WorkstationService WorkstationService
@inject IOptions<AppSettings> AppOptions
@inject NavigationManager Navigation
@inject UserSessionService UserSession
@inject AuthService AuthService
@inject IJSRuntime JSRuntime
@implements IDisposable

<h3 class="mb-4">Lista kuwet do spakowania</h3>

<div class="row">
    <!-- Left side: table -->
    <div class="col-md-8">
        @if (JlList == null)
        {
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Ładownie...</span>
                </div>
            </div>
        }
        else if (!JlList.Any())
        {
            <div class="alert alert-info">Brak kuwet do spakowania.</div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle table-tall">
                    <thead class="table-dark">
                        <tr>
                            <th>Lokalizacja</th>
                            <th>Kuweta</th>
                            <th>Waga (kg)</th>
                            <th>Kurier</th>
                            <th>Poza UE</th>
                            <th>Klient</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var (item, index) in JlList.Select((value, i) => (value, i)))
                        {
                            var rowClass = item.Status switch
                            {
                                1 => index % 2 == 0 ? "table-success" : "table-light",
                                2 => "table-danger",
                                3 => "table-warning",
                                _ => ""
                            };

                            <tr class="@rowClass clickable-row" ondblclick="@(() => OnRowDoubleClick(item))">
                                <td>@item.LocationCode</td>
                                <td>@item.Name</td>
                                <td>@item.Weight.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)</td>
                                <td>@item.Courier.GetDescription()</td>
                                <td>
                                    @if (item.OutsideEU)
                                    {
                                        <span class="badge bg-danger">Tak</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">Nie</span>
                                    }
                                </td>
                                <td>@item.ClientSymbol</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>

    <!-- Right side: control panel -->
    <div class="col-md-4">
        <div class="card shadow-sm p-3">
            <div class="mb-3">
                <label for="kuwetaInput" class="form-label">Kuweta:</label>
                <input type="text"
                       @bind="Kuweta"
                       @bind:event="oninput"
                       @ref="InputRef"
                       @onkeydown="HandleKeyDown"
                       class="form-control" />
            </div>
            <button class="btn btn-primary w-100" @onclick="RefreshData">
                Odśwież
            </button>

            <!-- Extra info -->
            <div class="mt-3">
                <p><strong>Zalogowany operator:</strong> @UserSession.Username</p>
                <p><strong>Ilość kuwet (adresów):</strong> @JlReadyToPackCount (@AddressesCount)</p>
                <ManagerControlModal OnButtonClick="HandleManagerClick"
                                     OnRequestPassword="OnManagerButtonClick"
                                     ShowPackingButtons="false"
                                     @ref="ManagerModal" />
            </div>
        </div>
    </div>
</div>


<PasswordModal @ref="PasswordModal" />
<LoggedOperatorsModal @ref="LoggedOperatorsModal" />
<JlInProgressModal @ref="JlInProgressModal" />
<ChangePackingWarehouseModal @ref="ChangePackingWarehouseModal" />
<PackingJlItemsModal @ref="PackingJlItemsModal" />
<TextBoxModal @ref="TextBoxModal" />
<PackagesInBuforModal @ref="PackagesInBuforModal"/>
<MergeJlsModal @ref="MergeJlsModal" />
<ComboBoxModal @ref="ComboBoxModal" />

<Toast FocusAfterCloseInput="InputRef" @ref="Toast" />

@code  {
    private List<JlData> JlList = new();
    private string Kuweta { get; set; } = string.Empty;
    private System.Threading.Timer? RefreshListTimer;
    private System.Threading.Timer? AfkTimer;
    private ElementReference InputRef;
    private Toast Toast = new();
    private WorkstationSettings Settings = new();
    private AppSettings AppSettings => AppOptions.Value;

    private PasswordModal PasswordModal = new();
    private ManagerControlModal ManagerModal = new();
    private TextBoxModal TextBoxModal = new();
    private LoggedOperatorsModal LoggedOperatorsModal = new();
    private JlInProgressModal JlInProgressModal = new();
    private ChangePackingWarehouseModal ChangePackingWarehouseModal = new();
    private PackingJlItemsModal PackingJlItemsModal = new();
    private MergeJlsModal MergeJlsModal = new();
    private PackagesInBuforModal PackagesInBuforModal = new();
    private ComboBoxModal ComboBoxModal = new();

    private int JlReadyToPackCount { get; set; } = 0;
    private int AddressesCount { get; set; } = 0;
    private bool CanPackNotReady = false;

    protected override async Task OnInitializedAsync()
    {
        await UserSession.InitializeAsync();
        await LoadData();

        // Auto-refresh every 1 minute
        RefreshListTimer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(LoadData);
        }, null, TimeSpan.FromSeconds(AppSettings.Intervals.RefreshPackingList), TimeSpan.FromSeconds(AppSettings.Intervals.RefreshPackingList));

        AfkTimer = new System.Threading.Timer(async _ => await CheckAfkAsync(), null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("blazorFocus.focusElement", InputRef);
        }
    }

    private async Task LoadData()
    {
        try
        {
            Settings = await WorkstationService.GetSettingsAsync();
            JlList = await PackingService.GetJlList(Settings.PackingLevel);

            // Calculate count
            var jlReadyToPack = JlList.ToList();

            JlReadyToPackCount = jlReadyToPack.Count;
            AddressesCount = jlReadyToPack.Where(jl => !string.IsNullOrEmpty(jl.AddressName)).Select(jl => jl.AddressName).Distinct().Count();
        }
        catch (Exception ex)
        {
            Toast.Show("Błąd!", $"Błąd podczas zaczytywania kuwet: {ex.Message}");
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task RefreshData()
    {
        await LoadData();
        await JSRuntime.InvokeVoidAsync("blazorFocus.focusElement", InputRef);
    }

    private async Task CheckAfkAsync()
    {
        try
        {
            // get last activity from JS
            var lastActivity = await JSRuntime.InvokeAsync<long>("activityTracker.getLastActivity");
            var idleSeconds = (DateTimeOffset.UtcNow.ToUnixTimeMilliseconds() - lastActivity) / 1000;

            if (idleSeconds >= AppSettings.Intervals.Logout)
            {
                AfkTimer?.Dispose();
                await AuthService.Logout(UserSession.Username);
                await UserSession.LogoutAsync();
                Navigation.NavigateTo("/login", forceLoad: true);
            }
        }
        catch
        {
            // optionally ignore errors
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key != "Enter")
            return;

        var trimmedKuweta = Kuweta?.Trim();
        if (string.IsNullOrWhiteSpace(trimmedKuweta))
            return;

        // Find JL by barcode or name
        var jl = JlList.FirstOrDefault(x =>
            string.Equals(x.Name, trimmedKuweta, StringComparison.OrdinalIgnoreCase) ||
            string.Equals(x.Barcode, trimmedKuweta, StringComparison.OrdinalIgnoreCase));

        if (jl == null)
        {
            Toast.Show("Nie znaleziono", $"Nie znaleziono kuwet o kodzie '{Kuweta}'");
            Kuweta = string.Empty;
            await JSRuntime.InvokeVoidAsync("blazorFocus.focusElement", InputRef);
            return;
        }

        Kuweta = string.Empty;
        await JSRuntime.InvokeVoidAsync("blazorFocus.focusElement", InputRef);

        // Reuse existing logic from row double-click
        await OnRowDoubleClick(jl);
    }

    private async Task OnRowDoubleClick(JlData jl)
    {
        try
        {
            if (jl.Status == 2)
            {
                var password = await PasswordModal.ShowAsync("Wprowadź hasło do kuwety czerwonej");
                if (password == null)
                    return;

                bool valid = await AuthService.ValidatePasswordAsync(password);
                if (!valid)
                {
                    Toast.Show("Błąd!", "Błędne hasło");
                    return;
                }
            }

            if (jl.Status == 3)
            {
                Toast.Show("Pakowana", "Kuweta jest pakowana na innym stanowisku", ToastType.Error);
                return;
            }

            if (Settings.PackingLevel != PackingLevel.Dół)
            {
                // upper level logic
                if (jl.ClientName == "MIX")
                    Navigation.NavigateTo($"/kontrola-pakowania/{jl.Name}/single");
                else
                    Navigation.NavigateTo($"/kontrola-pakowania/{jl.Name}");

                return;
            }

            PackageSelectionResult? selectedPackage = null;
            List<(string jlCode, string location)> selectedMergeJls = new();

            //
            // 1️ BUFOR CHECK
            //
            var packagesInBufor = await PackingService.GetPackagesForClient(
                jl.ClientId,
                jl.AddressName,
                jl.AddressCity,
                jl.AddressStreet,
                jl.AddressPostalCode,
                jl.AddressCountry,
                DocumentStatus.Bufor);

            if (packagesInBufor?.Any() == true)
            {
                selectedPackage = await PackagesInBuforModal.Show(packagesInBufor);
            }

            //
            // 2️ FIND OTHER JLs W/ SAME ADDRESS
            //
            var matchingJls = JlList
                .Where(x =>
                    x.Id != jl.Id &&
                    x.AddressName == jl.AddressName &&
                    x.AddressCity == jl.AddressCity &&
                    x.AddressCountry == jl.AddressCountry &&
                    x.AddressStreet == jl.AddressStreet)
                .ToList();

            if (matchingJls.Any())
            {
                selectedMergeJls = await MergeJlsModal.Show(matchingJls);
            }

            //
            // 3️ BUILD FINAL NAVIGATION URL ONCE
            //

            string url;
            if (jl.ClientName == "MIX")
                url = $"/kontrola-pakowania/{jl.Name}/single";
            else
                url = $"/kontrola-pakowania/{jl.Name}";

            List<string> queryParts = new();

            if (selectedPackage is not null)
            {
                if (selectedPackage.PackageId.HasValue)
                    queryParts.Add($"o={selectedPackage.PackageId}");

                if (!string.IsNullOrWhiteSpace(selectedPackage.InternalBarcode))
                    queryParts.Add($"barcode={selectedPackage.InternalBarcode}");
            }

            if (selectedMergeJls.Any())
            {
                var encoded = selectedMergeJls
                    .Select(x => $"{Uri.EscapeDataString(x.jlCode)}|{Uri.EscapeDataString(x.location)}");

                queryParts.Add($"mergeJls={string.Join(",", encoded)}");
            }

            if (queryParts.Any())
                url += "?" + string.Join("&", queryParts);

            Navigation.NavigateTo(url);
        }
        catch (Exception ex)
        {
            Toast.Show("Błąd", $"Błąd przy próbie podjęcia kuwety {ex.Message}", ToastType.Error);
        }
    }


    private async Task OnManagerButtonClick()
    {
        var password = await PasswordModal.ShowAsync();
        if (password == null)
            return;

        bool valid = await AuthService.ValidatePasswordAsync(password);
        if (!valid)
        {
            Toast.Show("Błąd!", "Błędne hasło");
            return;
        }
        ManagerModal.OpenModal();
        StateHasChanged();
    }

    private async void HandleManagerClick(int returnClick)
    {
        switch (returnClick)
        {
            case 3: /* Zawartość */
                var barcode = await TextBoxModal.Show("Zawartość kuwety", "Wprowadź kod wewnętrzny", "Kod wewnętrzny");
                if (!string.IsNullOrEmpty(barcode))
                {
                    await PackingJlItemsModal.ShowModal(barcode);
                }
                break;
            case 5: /* Zalogowani */
                await LoggedOperatorsModal.ShowModal();
                break;
            case 6: /* Kuwety podjęte */
                await JlInProgressModal.ShowModal();
                break;
            case 7: /* Zwolnij */
                try
                {
                    var packages = await PackingService.GetNotClosedPackages();
                    var comboBoxes = new List<ComboBoxDefinition>
                    {
                        new()
                        {
                            Label = "Paczka",
                            Placeholder = "Wybierz paczke",
                            Items = packages
                        },
                        new()
                        {
                            Label = "Lokalizacja docelowa",
                            Placeholder = "Wybierz lokalizację docelową",
                            Items = new() { "Zrzuty-rolotok-1-1-1", "Zrzuty-rolotok-1-2-1", "Zrzuty-rolotok-1-3-1", "Zrzuty-rolotok-1-4-1", "Zrzuty-rolotok-1-5-1", "A - Załadunek-1-1-1", "B - Załadunek-1-1-1" }
                        }
                    };

                    var result = await ComboBoxModal.Show("Zamknij paczke", "Wybierz paczke do zamknięcia. Zostanie jej nadany status 'Gotowa do załadunku'", comboBoxes);

                    if (result != null)
                    {
                        var closeWmsJlRequest = new WmsCloseJlRequest
                        {
                            PackageNumber = result[0],
                            PackageDestination = result[1],
                            PackingLevel = Settings.PackingLevel,
                            PackingWarehouse = Settings.PackingWarehouse,
                            Courier = Courier.Unknown
                        };
                        var success = await PackingService.CloseWmsJl(closeWmsJlRequest);
                        if (success)
                            Toast.Show("Sukces!", "Paczka została pomyślnie zamknięta.", ToastType.Success);
                    }
                }
                catch (Exception ex)
                {
                    Toast.Show("Błąd!", $"Błąd przy próbie zwolnienia paczki: {ex.Message}");
                }
                break;
            case 8: /* Zmień magazyn */
                await ChangePackingWarehouseModal.Show();
                break;

            case 9: /* Zabuforuj */
                try
                {
                    var internalBarcode = await TextBoxModal.Show("Odbuforuj paczkę/palete.", "Zeskanuj kod kreskowy paczki/palety, która jest zatwierdona i nie została wygenerowana do niej wysyłka. Paczka zmieni status na bufor.", "Kod kreskowy");
                    if (!string.IsNullOrEmpty(internalBarcode))
                    {
                        var success = await PackingService.BufferPackage(internalBarcode);
                        if (!success)
                        {
                            Toast.Show("Błąd!", "Nie udało się odbuforować paczki. Spróbuj ponownie.");
                            return;
                        }

                        Toast.Show("Sukces!", "Paczka została pomyślnie zabuforowana.", ToastType.Success);
                    }
                }
                catch (Exception ex)
                {
                    Toast.Show("Błąd!", $"Błąd przy próbie odbuforowania paczki: {ex.Message}");
                }
                break;
        }
        await JSRuntime.InvokeVoidAsync("blazorFocus.focusElement", InputRef);
    }

    public void Dispose()
    {
        RefreshListTimer?.Dispose();
        AfkTimer?.Dispose();
    }
}
