@page "/kontrola-pakowania"
@inherits ProtectedPageBase

@using KontrolaPakowania.Shared.DTOs.Requests
@using KontrolaPakowania.Shared.Enums
@using KontrolaPakowania.Shared.Helpers
@inject PackingService PackingService
@inject WorkstationService WorkstationService
@inject NavigationManager Navigation
@inject UserSessionService UserSession
@inject AuthService AuthService
@inject IJSRuntime JSRuntime
@implements IDisposable

<h3 class="mb-4">Lista kuwet do spakowania</h3>

<div class="row">
    <!-- Left side: table -->
    <div class="col-md-8">
        @if (JlList == null)
        {
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }
        else if (!JlList.Any())
        {
            <div class="alert alert-info">No items found.</div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle table-tall">
                    <thead class="table-dark">
                        <tr>
                            <th>Kuweta</th>
                            <th>Waga (kg)</th>
                            <th>Kurier</th>
                            <th>Poza UE</th>
                            <th>Klient</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var (item, index) in JlList.Select((value, i) => (value, i)))
                        {
                            var rowClass = item.Status switch
                            {
                                1 => index % 2 == 0 ? "table-success" : "table-light",
                                2 => "table-warning",
                                3 => "table-danger",
                                _ => ""
                            };

                            <tr class="@rowClass clickable-row" ondblclick="@(() => OnRowDoubleClick(item))">
                                <td>@item.Name</td>
                                <td>@item.Weight.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)</td>
                                <td>@item.Courier.GetDescription()</td>
                                <td>
                                    @if (item.OutsideEU)
                                    {
                                        <span class="badge bg-danger">Tak</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">Nie</span>
                                    }
                                </td>
                                <td>@item.ClientName</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>

    <!-- Right side: control panel -->
    <div class="col-md-4">
        <div class="card shadow-sm p-3">
            <div class="mb-3">
                <label for="kuwetaInput" class="form-label">Kuweta:</label>
                <input type="text" @ref="kuwetaInputRef" class="form-control" @bind="Kuweta" />
            </div>
            <button class="btn btn-primary w-100" @onclick="RefreshData">
                Odśwież
            </button>

            <!-- Extra info -->
            <div class="mt-3">
                <p><strong>Zalogowany operator:</strong> @UserSession.Username</p>
                <p><strong>Ilość kuwet (adresów):</strong> @JlReadyToPackCount (@AddressesCount)</p>
                <ManagerControlModal OnButtonClick="HandleManagerClick"
                                     OnRequestPassword="OnManagerButtonClick"
                                     ShowPackingButtons="false"
                                     @ref="ManagerModal" />
            </div>
        </div>
    </div>
</div>


<PasswordModal @ref="PasswordModal" OnConfirm="HandlePasswordConfirm" />
<LoggedOperatorsModal @ref="LoggedOperatorsModal" />
<JlInProgressModal @ref="JlInProgressModal" />
<ChangePackingWarehouseModal @ref="ChangePackingWarehouseModal" />
<PackingJlItemsModal @ref="PackingJlItemsModal" />
<TextBoxModal @ref="TextBoxModal" />
<MergeJlsModal @ref="MergeJlsModal" />

<Toast @ref="Toast"/>

@code  {
    private List<JlDto> JlList = new();
    private string Kuweta { get; set; } = string.Empty;
    private System.Threading.Timer? _timer;
    private ElementReference kuwetaInputRef;
    private Toast Toast = new();
    private WorkstationSettings Settings = new();

    private PasswordModal PasswordModal = new();
    private ManagerControlModal ManagerModal = new();
    private TextBoxModal TextBoxModal = new();
    private LoggedOperatorsModal LoggedOperatorsModal = new();
    private JlInProgressModal JlInProgressModal = new();
    private ChangePackingWarehouseModal ChangePackingWarehouseModal = new();
    private PackingJlItemsModal PackingJlItemsModal = new();
    private MergeJlsModal MergeJlsModal = new();

    private int JlReadyToPackCount { get; set; } = 0;
    private int AddressesCount { get; set; } = 0;
    private PasswordPurpose CurrentPasswordPurpose = PasswordPurpose.None;

    protected override async Task OnInitializedAsync()
    {
        await UserSession.InitializeAsync();
        await LoadData();

        // Auto-refresh every 1 minute
        _timer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(LoadData);
        }, null, TimeSpan.FromMinutes(1), TimeSpan.FromMinutes(1));
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("blazorFocus.focusElementRef", kuwetaInputRef);
        }
    }

    private async Task LoadData()
    {
        try
        {
            Settings = await WorkstationService.GetSettingsAsync();
            JlList = await PackingService.GetJlList(Settings.PackingLevel);

            // Calculate count
            var jlReadyToPack = JlList.Where(jl => jl.Status == 1).ToList();

            JlReadyToPackCount = jlReadyToPack.Count;
            AddressesCount = jlReadyToPack.Select(jl => jl.ClientAddressId).Distinct().Count();
        }
        catch (Exception ex)
        {
            Toast.Show("Błąd!", $"Błąd podczas zaczytywania kuwet: {ex.Message}");
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task RefreshData()
    {
        await LoadData();
        await JSRuntime.InvokeVoidAsync("blazorFocus.focusElementRef", kuwetaInputRef);
    }

    private async Task OnRowDoubleClick(JlDto jl)
    {
        if (Settings.PackingLevel == PackingLevel.Dół)
        {
            // Check for other JLs with the same client address
            var matchingJls = JlList
                .Where(x => x.ClientAddressId == jl.ClientAddressId && x.Id != jl.Id)
                .ToList();

            if (matchingJls.Count > 0)
            {
                // Show modal letting user select which JLs to merge
                var selectedIds = await MergeJlsModal.Show(matchingJls);

                if (selectedIds.Any())
                {
                    // Navigate to base JL and pass selected JLs as query
                    var query = string.Join(",", selectedIds);
                    Navigation.NavigateTo($"/kontrola-pakowania/{jl.Name}?mergeNames={query}");
                }
                else
                {
                    Navigation.NavigateTo($"/kontrola-pakowania/{jl.Name}");
                }
            }
            else
            {
                Navigation.NavigateTo($"/kontrola-pakowania/{jl.Name}");
            }
        }
        else
        {
            Navigation.NavigateTo($"/kontrola-pakowania/{jl.Name}");
        }
    }

    // Single password confirm handler
    private async Task HandlePasswordConfirm(string password)
    {
        bool valid = await AuthService.ValidatePasswordAsync(password);
        if (!valid)
        {
            Toast.Show("Błąd!", "Błędne hasło");
            return;
        }
        await PasswordModal.Hide();
        switch (CurrentPasswordPurpose)
        {
            case PasswordPurpose.ManagerAction:
                ManagerModal.OpenModal();
                break;
        }

        CurrentPasswordPurpose = PasswordPurpose.None;
    }

    private async Task OnManagerButtonClick()
    {
        CurrentPasswordPurpose = PasswordPurpose.ManagerAction;
        await PasswordModal.Show();
        StateHasChanged();
    }

    private async void HandleManagerClick(int returnClick)
    {
        switch (returnClick)
        {
            case 3: /* Zawartość */
                var barcode = await TextBoxModal.Show("Zawartość kuwety", "Wprowadź kod wewnętrzny", "Kod wewnętrzny");
                if (!string.IsNullOrEmpty(barcode))
                {
                    await PackingJlItemsModal.ShowModal(barcode);
                }
                break;
            case 5: /* Zalogowani */
                await LoggedOperatorsModal.ShowModal();
                break;
            case 6: /* Kuwety podjęte */
                await JlInProgressModal.ShowModal();
                break;
            case 7: /* Zwolnij */
                var jlCode = await TextBoxModal.Show("Zwolnij kuwetę", "Wprowadź kod kuwety", "Kod kuwety");
                if (!string.IsNullOrEmpty(jlCode))
                {
                    var releaseSuccess = await PackingService.ReleaseJl(jlCode);
                    if (!releaseSuccess)
                    {
                        Toast.Show("Błąd!", "Kuweta nie została zwolniona. Spróbuj ponownie.");
                        return;
                    }
                }
                break;
            case 8: /* Zmień magazyn */
                await ChangePackingWarehouseModal.Show();
                break;
        }
        await JSRuntime.InvokeVoidAsync("blazorFocus.focusElementRef", kuwetaInputRef);
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }
}
