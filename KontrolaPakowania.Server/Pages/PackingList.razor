@page "/kontrola-pakowania"
@inherits ProtectedPageBase

@using KontrolaPakowania.Shared.DTOs.Requests
@using KontrolaPakowania.Shared.Enums
@inject PackingService PackingService
@inject WorkstationService WorkstationService
@inject NavigationManager Navigation
@inject UserSessionService UserSession
@inject AuthService AuthService
@inject IJSRuntime JSRuntime
@implements IDisposable

<h3 class="mb-4">Lista kuwet do spakowania</h3>

<div class="row">
    <!-- Left side: table -->
    <div class="col-md-8">
        @if (JlList == null)
        {
            <div class="text-center">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }
        else if (!JlList.Any())
        {
            <div class="alert alert-info">No items found.</div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>Kuweta</th>
                            <th>Waga (kg)</th>
                            <th>Kurier</th>
                            <th>Poza UE</th>
                            <th>Klient</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var (item, index) in JlList.Select((value, i) => (value, i)))
                        {
                            var rowClass = item.Status switch
                            {
                                1 => index % 2 == 0 ? "table-success" : "table-light",
                                2 => "table-warning",
                                3 => "table-danger",
                                _ => ""
                            };

                            <tr class="@rowClass clickable-row" ondblclick="@(() => OnRowDoubleClick(item))">
                                <td>@item.Name</td>
                                <td>@item.Weight.ToString("F2", System.Globalization.CultureInfo.InvariantCulture)</td>
                                <td>@item.Courier</td>
                                <td>
                                    @if (item.OutsideEU)
                                    {
                                        <span class="badge bg-danger">Tak</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">Nie</span>
                                    }
                                </td>
                                <td>@item.ClientName</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>

    <!-- Right side: control panel -->
    <div class="col-md-4">
        <div class="card shadow-sm p-3">
            <div class="mb-3">
                <label for="kuwetaInput" class="form-label">Kuweta:</label>
                <input type="text" @ref="kuwetaInputRef" class="form-control" @bind="Kuweta" />
            </div>
            <button class="btn btn-primary w-100" @onclick="RefreshData">
                Odśwież
            </button>

            <!-- Extra info -->
            <div class="mt-3">
                <p><strong>Zalogowany operator:</strong> @Username</p>
                <p><strong>Ilość kuwet (adresów):</strong> @JlReadyToPackCount (@AddressesCount)</p>
                <ManagerControlModal OnButtonClick="HandleManagerClick"
                                     OnRequestPassword="OnManagerButtonClick"
                                     ShowPackingButtons="false"
                                     @ref="ManagerModal" />
            </div>
        </div>
    </div>
</div>

@if (ShowPasswordModal)
{
    <PasswordModal Title="Wpisz hasło"
                   OnConfirm="HandlePasswordConfirm"
                   OnClose="() => ShowPasswordModal = false" />
}

<LoggedOperatorsModal @ref="LoggedOperatorsModal" />
<JlInProgressModal @ref="JlInProgressModal" />
<PackingJlItemsModal @ref="PackingJlItemsModal" />
<TextBoxModal @ref="TextBoxModal" />

<Toast @ref="ToastError" Title="Error" Color="danger" />

@code  {
    private bool ShowPasswordModal = false;
    private List<JlDto>? JlList;
    private string Kuweta { get; set; } = string.Empty;
    private System.Threading.Timer? _timer;
    private ElementReference kuwetaInputRef;
    private Toast ToastError = new();
    private JlDto? SelectedJl;
    private WorkstationSettings? Settings;

    private ManagerControlModal ManagerModal = new();
    private TextBoxModal TextBoxModal = new();
    private LoggedOperatorsModal LoggedOperatorsModal = new();
    private JlInProgressModal JlInProgressModal = new();
    private PackingJlItemsModal PackingJlItemsModal = new();

    private int JlReadyToPackCount { get; set; } = 0;
    private int AddressesCount { get; set; } = 0;
    private string Username { get; set; } = string.Empty;
    private PasswordPurpose CurrentPasswordPurpose = PasswordPurpose.None;

    protected override async Task OnInitializedAsync()
    {
        Username = UserSession.Username;
        await LoadData();

        // Auto-refresh every 1 minute
        _timer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(LoadData);
        }, null, TimeSpan.FromMinutes(1), TimeSpan.FromMinutes(1));
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("blazorFocus.focusElementRef", kuwetaInputRef);
        }
    }

    private async Task LoadData()
    {
        try
        {
            Settings = await WorkstationService.GetSettingsAsync();

            JlList = await PackingService.GetJlList(Settings.PackingLocation);

            // Calculate count
            var jlReadyToPack = JlList.Where(jl => jl.Status == 1).ToList();

            JlReadyToPackCount = jlReadyToPack.Count;
            AddressesCount = jlReadyToPack.Select(jl => jl.ClientAddressId).Distinct().Count();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching data: {ex.Message}");
            JlList = new List<JlDto>();
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task RefreshData()
    {
        await LoadData();
    }

    private async void OnRowDoubleClick(JlDto jl)
    {
        SelectedJl = jl;
        if (jl.Status != 1)
        {
            CurrentPasswordPurpose = PasswordPurpose.JlNotReadyAction;
            ShowPasswordModal = true;
            await InvokeAsync(StateHasChanged);
        }
        else
        {
            Navigation.NavigateTo($"/kontrola-pakowania/{jl.Name}");
        }
    }

    // Single password confirm handler
    private async Task HandlePasswordConfirm(string password)
    {
        ShowPasswordModal = false;

        bool valid = await AuthService.ValidatePasswordAsync(password);
        if (!valid)
        {
            await ToastError.Show("Błędne hasło");
            await Task.Delay(4000);
            await ToastError.Hide();
            return;
        }

        switch (CurrentPasswordPurpose)
        {
            case PasswordPurpose.JlNotReadyAction:
                Navigation.NavigateTo($"/kontrola-pakowania/{SelectedJl.Name}");
                break;

            case PasswordPurpose.ManagerAction:
                ManagerModal.OpenModal();
                break;
        }

        CurrentPasswordPurpose = PasswordPurpose.None;
    }

    private void OnManagerButtonClick()
    {
        CurrentPasswordPurpose = PasswordPurpose.ManagerAction;
        ShowPasswordModal = true;
        StateHasChanged();
    }

    private async void HandleManagerClick(int returnClick)
    {
        switch (returnClick)
        {
            case 3: /* Zawartość */
                var barcode = await TextBoxModal.Show("Zawartość kuwety", "Wprowadź kod wewnętrzny", "Kod wewnętrzny");
                if (!string.IsNullOrEmpty(barcode))
                {
                    await PackingJlItemsModal.ShowModal(barcode);
                }
                break;
            case 5: /* Zalogowani */
                await LoggedOperatorsModal.ShowModal();
                break;
            case 6: /* Kuwety podjęte */
                await JlInProgressModal.ShowModal();
                break;
            case 7: /* Zwolnij */
                var jlCode = await TextBoxModal.Show("Zwolnij kuwetę", "Wprowadź kod kuwety", "Kod kuwety");
                if (!string.IsNullOrEmpty(jlCode))
                {
                    var releaseSuccess = await PackingService.ReleaseJl(jlCode);
                    if (!releaseSuccess)
                    {
                        await ToastError.Show("Kuweta nie została zwolniona. Spróbuj ponownie.");
                        await Task.Delay(6000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
                        return;
                    }
                }
                break;
            case 8: /* Zmień magazyn */ break;
        }
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }
}
