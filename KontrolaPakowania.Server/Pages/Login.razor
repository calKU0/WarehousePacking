@page "/login"
@inject UserSessionService UserSession
@inject NavigationManager Navigation
@inject AuthService AuthService
@inject WorkstationService WorkstationService
@inject IJSRuntime JSRuntime
@layout NoNavLayout

<div class="login-container d-flex justify-content-center align-items-center min-vh-100">
    <div class="card shadow-lg p-4 login-card">
        <h3 class="card-title text-center mb-4">Login</h3>

        @if (UserSession.IsLoggedIn)
        {
            <div class="text-center">
                <p class="mb-3">Logged in as: <strong>@UserSession.Username</strong></p>
                <button class="btn btn-danger btn-lg" @onclick="Logout">
                    <i class="bi bi-box-arrow-right me-2"></i> Logout
                </button>
            </div>
        }
        else
        {
            <EditForm Model="loginDto" OnValidSubmit="HandleLogin">
                <div class="mb-3">
                    <label class="form-label">Nazwa użytkownika</label>
<input @ref="UsernameInput"
       class="form-control form-control-lg"
       @bind="loginDto.Username"
       @onkeydown="HandleUsernameKeyDown"
       placeholder="Wprowadź nazwę użytkownika" />

                </div>

                <div class="mb-3">
                    <label class="form-label">Hasło</label>
                    <input @ref="PasswordInput"
                           class="form-control form-control-lg"
                           @bind="loginDto.Password"
                           placeholder="Wprowadź hasło" />
                </div>

                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-box-arrow-in-right me-2"></i> Zaloguj
                    </button>
                </div>
            </EditForm>
        }
    </div>
</div>

<Toast @ref="ToastError" Title="Error" Color="danger" />

@code {
    private LoginDto loginDto = new();
    private Toast ToastError = new ();
    private WorkstationSettings Settings = new();
    private ElementReference UsernameInput;
    private ElementReference PasswordInput;
    private string scannedUsername = "";


    protected override async Task OnInitializedAsync()
    {
        await UserSession.InitializeAsync();
        Settings = await WorkstationService.GetSettingsAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("blazorFocus.focusElementRef", UsernameInput);
        }
    }

    private void OnUsernameInput(ChangeEventArgs e)
    {
        scannedUsername = e.Value?.ToString() ?? "";
    }

    private async Task HandleUsernameKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            // Move focus to password when Enter is pressed
            await JSRuntime.InvokeVoidAsync("blazorFocus.focusElementRef", PasswordInput);
        }
    }

    private async Task HandleLogin()
    {
        try
        {
            loginDto.StationNumber = Settings.StationNumber;
            loginDto.LoginDate = DateTime.Now;

            bool validCredentials = await AuthService.Login(loginDto);
            if (validCredentials)
            {
                await UserSession.LoginAsync(loginDto.Username);
                Navigation.NavigateTo("/");
            }

            else
            {
                await ToastError.Show("Nieprawidłowa nazwa użytkownika lub hasło.");
                await Task.Delay(4000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
            }
        }
        catch (Exception ex)
        {
            await ToastError.Show($"Błąd przy próbie zalogowania {ex.Message}");
            await Task.Delay(4000).ContinueWith(_ => InvokeAsync(() => ToastError.Hide()));
        }
    }

    private async Task Logout()
    {
        await AuthService.Logout(UserSession.Username);
        await UserSession.LogoutAsync();
        Navigation.NavigateTo("/login");
    }
}