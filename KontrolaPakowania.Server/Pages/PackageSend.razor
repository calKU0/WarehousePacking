@page "/wysylka-paczek"
@using KontrolaPakowania.Shared.DTOs.Requests
@using KontrolaPakowania.Shared.Enums
@using KontrolaPakowania.Shared.Helpers
@inject UserSessionService UserSession
@inject ShipmentService ShipmentService
@inject WorkstationService WorkstationService
@inject ClientPrinterService ClientPrinterService
@inject IJSRuntime JSRuntime

<div class="container-fluid package-send position-relative">
    <!-- Barcode Input Full Width -->
    <div class="mb-3 row">
        <div class="col-12">
            <label class="form-label">Kod kreskowy</label>
            <input @bind="Barcode"
                   @bind:event="oninput"
                   @ref="InputRef"
                   placeholder="Zeskanuj kod kreskowy..."
                   class="form-control"
                   @onkeydown="HandleKeyDown" />
        </div>
    </div>

    <!-- Two Column Layout -->
    <div class="row mt-5">
        <!-- Left Column: Shipment Data -->
        <div class="col-md-9">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Akronim</label>
                    <InputText @bind-Value="Package.RecipientName" class="form-control" disabled="@(!ManualEdit)" autocomplete="off" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Nazwa</label>
                    <InputText @bind-Value="Package.RecipientName" class="form-control" disabled="@(!ManualEdit)" autocomplete="off" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Ulica</label>
                    <InputText @bind-Value="Package.RecipientStreet" class="form-control" disabled="@(!ManualEdit)" autocomplete="off" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Kod Pocztowy</label>
                    <InputText @bind-Value="Package.RecipientPostalCode" class="form-control" disabled="@(!ManualEdit)" autocomplete="off" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Miasto</label>
                    <InputText @bind-Value="Package.RecipientCity" class="form-control" disabled="@(!ManualEdit)" autocomplete="off" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Kraj</label>
                    <InputText @bind-Value="Package.RecipientCountry" class="form-control" disabled="@(!ManualEdit)" autocomplete="off" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Telefon</label>
                    <InputText @bind-Value="Package.RecipientPhone" class="form-control" disabled="@(!ManualEdit)" autocomplete="off" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Mail</label>
                    <InputText @bind-Value="Package.RecipientEmail" type="email" class="form-control" disabled="@(!ManualEdit)" autocomplete="off" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Pobranie</label>
                    <InputNumber @bind-Value="Package.ShipmentServices.CODAmount" class="form-control" disabled="@(!ManualEdit)" autocomplete="off" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Waga (kg)</label>
                    <InputNumber @bind-Value="Package.Weight" step="0.01" class="form-control" disabled="@(!ManualEdit)" autocomplete="off" />
                </div>
            </div>

            <!-- Courier & Type -->
            <div class="row g-3 mt-3 mb-4 align-items-center">
                <div class="col-md-3">
                    <label class="form-label fw-bold">Kurier</label>
                    <InputSelect @bind-Value="Package.Courier" class="form-select" disabled="@(!ManualEdit)">
                        @foreach (var courier in Enum.GetValues<Courier>())
                        {
                            <option value="@courier">@courier.GetDescription()</option>
                        }
                    </InputSelect>
                </div>

                <div class="col-md-3 d-flex justify-content-center align-items-center">
                    @if (!string.IsNullOrEmpty(Package.CourierLogo))
                    {
                        <img src="@Utils.GetCourierSrc(Package.CourierLogo)"
                             alt="Courier Logo"
                             class="img-fluid"
                             style="max-height:120px;" />
                    }
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-bold">Typ paczki</label>
                    <InputSelect @bind-Value="Package.PackageType" class="form-select" disabled="@(!ManualEdit)">
                        @foreach (var type in Enum.GetValues<PackageType>())
                        {
                            <option value="@type">@type.GetDescription()</option>
                        }
                    </InputSelect>
                </div>
            </div>

            <!-- Buttons Full Width Row -->
            <div class="row g-2 mb-4">
                <div class="col-md-6 d-grid">
                    <button class="btn btn-success tall-btn" disabled="@(Package.Id == 0)" @onclick="SendPackage">Wyślij paczkę</button>
                </div>
                <div class="col-md-6 d-grid">
                    <button class="btn btn-secondary tall-btn" disabled="@(Package.Id == 0)" @onclick="ClearData">Wyczyść</button>
                </div>
            </div>
        </div>

        <!-- Right Column: Services + Additional Options -->
        <div class="col-md-3">
            <!-- Services Card -->
            <div class="card shadow-sm p-3 mb-4">
                <h5 class="card-title">Usługi dodatkowe</h5>
                <div class="row row-cols-2 row-cols-md-2 g-2">
                    <div class="form-check">
                        <InputCheckbox @bind-Value="Package.ShipmentServices.POD"
                                       class="form-check-input"
                                       disabled="@( !ManualEdit )" />
                        <label class="form-check-label">Potwierdzenie dostawy</label>
                    </div>
                    <div class="form-check">
                        <InputCheckbox @bind-Value="Package.ShipmentServices.EXW"
                                       class="form-check-input"
                                       disabled="@( !ManualEdit )" />
                        <label class="form-check-label">Na koszt odbiorcy</label>
                    </div>
                    <div class="form-check">
                        <InputCheckbox @bind-Value="Package.ShipmentServices.ROD"
                                       class="form-check-input"
                                       disabled="@( !ManualEdit )" />
                        <label class="form-check-label">Zwrot dokumentów</label>
                    </div>
                    <div class="form-check">
                        <InputCheckbox @bind-Value="Package.ShipmentServices.D10"
                                       class="form-check-input"
                                       disabled="@( !ManualEdit )" />
                        <label class="form-check-label">Dostawa do 10</label>
                    </div>
                    <div class="form-check">
                        <InputCheckbox @bind-Value="Package.ShipmentServices.D12"
                                       class="form-check-input"
                                       disabled="@( !ManualEdit )" />
                        <label class="form-check-label">Dostawa do 12</label>
                    </div>
                    <div class="form-check">
                        <InputCheckbox @bind-Value="Package.ShipmentServices.Saturday"
                                       class="form-check-input"
                                       disabled="@( !ManualEdit )" />
                        <label class="form-check-label">Sobota</label>
                    </div>
                    <div class="form-check">
                        <InputCheckbox @bind-Value="Package.ShipmentServices.COD"
                                       class="form-check-input"
                                       disabled="@( !ManualEdit )" />
                        <label class="form-check-label">Pobranie</label>
                    </div>
                </div>
            </div>

            <!-- Additional Options Card -->
            <div class="card shadow-sm p-3 mb-4">
                <h5 class="card-title">Opcje dodatkowe</h5>
                <div class="form-check mb-3">
                    <InputCheckbox @bind-Value="ManualEdit" class="form-check-input" />
                    <label class="form-check-label text-danger fw-bold">Modyfikuj dane ręcznie</label>
                </div>

                <div class="d-flex flex-column gap-2">
                    <button class="btn btn-outline-primary">Zamknij Trase DPD</button>
                    <button class="btn btn-outline-success">Zamknij Trase GLS</button>
                    <button class="btn btn-outline-danger mb-3">Zamknij Trase Fedex</button>
                    <button class="btn btn-info" disabled="@(Package.Id == 0)" @onclick=SendEmail>Wyślij mail do opiekuna</button>
                </div>
            </div>
        </div>
    </div>
</div>

<Toast @ref="Toast" />
<EmailModal @ref="EmailModal" />
<ShipmentModal @ref="ShipmentModal" />
<ConfirmDialog @ref="ConfirmDialog" OnCancelClicked="HideConfirm" OnConfirmClicked="ConfirmDelete" />

@code {
    private string Barcode { get; set; } = string.Empty;
    private PackageData Package { get; set; } = new();
    private WorkstationSettings Settings = new();
    private bool ManualEdit { get; set; }
    private ElementReference InputRef;

    private ShipmentModal ShipmentModal = new();
    private ConfirmDialog ConfirmDialog = new();
    private Toast Toast = new();
    private EmailModal EmailModal = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            Settings = await WorkstationService.GetSettingsAsync();
        }
        catch (Exception ex)
        {
            Toast.Show("Błąd!", $"Błąd przy próbie pobrania ustawień stanowiska: {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("blazorFocus.focusElementRef", InputRef);
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await LoadData();
        }
    }

    private async Task LoadData()
    {
        try
        {
            var response = await ShipmentService.GetShipmentDataByBarcode(Barcode);
            if (response == null)
            {
                Toast.Show("Brak paczki!", $"Nie znalaziono paczki o podanym kodzie kreskowym w systmie");
                return;
            }

            Package = response;
            if (Package.WysNumber != 0)
            {
                ConfirmDialog.Show("Usuń przesyłke", "Przesyłka do tej paczki została wygenerowana. Czy chcesz ją usunąć?");
            }
        }
        catch (Exception ex)
        {
            Toast.Show("Błąd!", $"Błąd przy próbie pobrania danych paczki: {ex.Message}");
            Barcode = string.Empty;
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
            await JSRuntime.InvokeVoidAsync("blazorFocus.focusElementRef", InputRef);
        }
    }


    private async Task SendPackage()
    {
        try
        {
            var response = await ShipmentService.SendPackage(Package);
            if (response?.PackageId > 0)
            {
                if (!string.IsNullOrEmpty(response.LabelBase64))
                {
                    var labelContent = response.LabelBase64;
                    await ClientPrinterService.PrintAsync(Settings.PrinterLabel, response.LabelType.ToString(), labelContent);
                    ShipmentModal.Show(response.TrackingNumber, response.LabelBase64, response.LabelType, Settings.PrinterLabel, Package.HasInvoice);
                    if (Package.HasInvoice)
                    {
                        await ClientPrinterService.PrintCrystalAsync(Settings.PrinterInvoice, Package.RecipientCountry != "PL" ? "InvoiceEN" : "InvoicePL", new Dictionary<string, string> { { "DocumentId", Package.InvoiceId.ToString() } });
                    }
                }
                else
                {
                    var msg = string.IsNullOrWhiteSpace(response.ErrorMessage) ? "Nie udało się wygenerować etykiety kurierskiej!" : response.ErrorMessage;
                    Toast.Show("Błąd!", msg);
                }
            }
            else
            {
                var msg = string.IsNullOrWhiteSpace(response?.ErrorMessage) ? "Nie udało się wygenerować przesyłki!" : response.ErrorMessage;
                Toast.Show("Błąd!", msg);
            }
        }
        catch (Exception ex)
        {
            Toast.Show("Błąd!", $"Błąd przy próbie wysłania paczki: {ex.Message}");
        }
        finally
        {
            await ClearData();
            await JSRuntime.InvokeVoidAsync("blazorFocus.focusElementRef", InputRef);
        }
    }

    private async Task ClearData()
    {
        Package = new();
        ManualEdit = false;
        Barcode = string.Empty;
        await JSRuntime.InvokeVoidAsync("blazorFocus.focusElementRef", InputRef);
        await InvokeAsync(StateHasChanged);
    }

    private async Task HideConfirm()
    {
        ConfirmDialog.Hide();
        await ClearData();
        await JSRuntime.InvokeVoidAsync("blazorFocus.focusElementRef", InputRef);
    }

    private async Task ConfirmDelete()
    {
        try
        {
            ConfirmDialog.Hide();
            await ShipmentService.DeleteShipment(Package.Courier, Package.WysNumber, Package.WysType);
        }
        catch (Exception ex)
        {
            Toast.Show("Błąd!", $"Błąd przy próbie usuwania paczki: {ex.Message}");
        }
        finally
        {
            await ClearData();
            await JSRuntime.InvokeVoidAsync("blazorFocus.focusElementRef", InputRef);
        }
    }

    private void SendEmail()
    {
        EmailModal.ShowModal(Package.RecipientName, Package.PackageName, Package.InvoiceName, Package.Representative, Package.RepresentativeEmail);
    }
}
