@page "/wysylka-paczek"
@using KontrolaPakowania.Server.Settings
@using KontrolaPakowania.Shared.DTOs.Requests
@using KontrolaPakowania.Shared.Enums
@using KontrolaPakowania.Shared.Helpers
@using Microsoft.Extensions.Options
@inject UserSessionService UserSession
@inject ShipmentService ShipmentService
@inject WorkstationService WorkstationService
@inject ClientPrinterService ClientPrinterService
@inject AuthService AuthService
@inject IOptions<AppSettings> AppOptions
@inject IJSRuntime JSRuntime
@implements IDisposable

<div class="container-fluid package-send position-relative">
    <!-- Barcode Input Full Width -->
    <div class="mb-3 row">
        <div class="col-12">
            <label class="form-label">Kod kreskowy</label>
            <input @bind="Barcode"
                   @bind:event="oninput"
                   @ref="InputRef"
                   placeholder="Zeskanuj kod kreskowy..."
                   class="form-control"
                   @onkeydown="HandleKeyDown" />
        </div>
    </div>

    <!-- Two Column Layout -->
    <div class="row mt-5">
        <!-- Left Column: Shipment Data -->
        <div class="col-md-9">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Akronim</label>
                    <InputText @bind-Value="Package.Recipient.Acronym" class="form-control" disabled="@(!Package.ManualEdit)" autocomplete="off" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Nazwa</label>
                    <InputText @bind-Value="Package.Recipient.Name" class="form-control" disabled="@(!Package.ManualEdit)" autocomplete="off" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Ulica</label>
                    <InputText @bind-Value="Package.Recipient.Street" class="form-control" disabled="@(!Package.ManualEdit)" autocomplete="off" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Kod Pocztowy</label>
                    <InputText @bind-Value="Package.Recipient.PostalCode" class="form-control" disabled="@(!Package.ManualEdit)" autocomplete="off" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Miasto</label>
                    <InputText @bind-Value="Package.Recipient.City" class="form-control" disabled="@(!Package.ManualEdit)" autocomplete="off" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Kraj</label>
                    <InputText @bind-Value="Package.Recipient.Country" class="form-control" disabled="@(!Package.ManualEdit)" autocomplete="off" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Telefon</label>
                    <InputText @bind-Value="Package.Recipient.Phone" class="form-control" disabled="@(!Package.ManualEdit)" autocomplete="off" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Mail</label>
                    <InputText @bind-Value="Package.Recipient.Email" type="email" class="form-control" disabled="@(!Package.ManualEdit)" autocomplete="off" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Pobranie</label>
                    <InputNumber @bind-Value="Package.ShipmentServices.CODAmount" class="form-control" disabled="@(!Package.ManualEdit)" autocomplete="off" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Waga (kg)</label>
                    <InputNumber @bind-Value="Package.Weight" step="0.01" class="form-control" disabled="@(!Package.ManualEdit)" autocomplete="off" />
                </div>
            </div>

            <!-- Courier & Type -->
            <div class="row g-3 mt-3 mb-4 align-items-center">
                <div class="col-md-3">
                    <label class="form-label fw-bold">Kurier</label>
                    <InputSelect @bind-Value="Package.Courier" class="form-select" disabled="@(!Package.ManualEdit)">
                        @foreach (var courier in Enum.GetValues<Courier>())
                        {
                            <option value="@courier">@courier.GetDescription()</option>
                        }
                    </InputSelect>
                </div>

                <div class="col-md-3 d-flex justify-content-center align-items-center">
                    @if (!string.IsNullOrEmpty(Package.CourierLogo))
                    {
                        <img src="@Utils.GetCourierSrc(Package.CourierLogo)"
                             alt="Courier Logo"
                             class="img-fluid"
                             style="max-height:120px;" />
                    }
                </div>

                <div class="col-md-6">
                    <label class="form-label fw-bold">Typ paczki</label>
                    <InputSelect @bind-Value="Package.PackageType" class="form-select" disabled="@(!Package.ManualEdit)">
                        @foreach (var type in Enum.GetValues<PackageType>())
                        {
                            <option value="@type">@type.GetDescription()</option>
                        }
                    </InputSelect>
                </div>
            </div>

            <!-- Buttons Full Width Row -->
            <div class="row g-2 mb-4">
                <div class="col-md-6 d-grid">
                    <button class="btn btn-success tall-btn" disabled="@(Package.Id == 0 && Package.ManualSend == false)" @onclick="SendPackage">Wyślij paczkę</button>
                </div>
                <div class="col-md-6 d-grid">
                    <button class="btn btn-secondary tall-btn" disabled="@(Package.Id == 0 && Package.ManualSend == false)" @onclick="ClearData">Wyczyść</button>
                </div>
            </div>
        </div>

        <!-- Right Column: Services + Additional Options -->
        <div class="col-md-3">
            <!-- Services Card -->
            <div class="card shadow-sm p-3 mb-4">
                <h5 class="card-title">Usługi dodatkowe</h5>
                <div class="row row-cols-2 row-cols-md-2 g-2">
                    <div class="form-check">
                        <InputCheckbox @bind-Value="Package.ShipmentServices.POD"
                                       class="form-check-input"
                                       disabled="@( !Package.ManualEdit )" />
                        <label class="form-check-label">Potwierdzenie dostawy</label>
                    </div>
                    <div class="form-check">
                        <InputCheckbox @bind-Value="Package.ShipmentServices.EXW"
                                       class="form-check-input"
                                       disabled="@( !Package.ManualEdit )" />
                        <label class="form-check-label">Na koszt odbiorcy</label>
                    </div>
                    <div class="form-check">
                        <InputCheckbox @bind-Value="Package.ShipmentServices.ROD"
                                       class="form-check-input"
                                       disabled="@( !Package.ManualEdit )" />
                        <label class="form-check-label">Zwrot dokumentów</label>
                    </div>
                    <div class="form-check">
                        <InputCheckbox @bind-Value="Package.ShipmentServices.D10"
                                       class="form-check-input"
                                       disabled="@( !Package.ManualEdit )" />
                        <label class="form-check-label">Dostawa do 10</label>
                    </div>
                    <div class="form-check">
                        <InputCheckbox @bind-Value="Package.ShipmentServices.D12"
                                       class="form-check-input"
                                       disabled="@( !Package.ManualEdit )" />
                        <label class="form-check-label">Dostawa do 12</label>
                    </div>
                    <div class="form-check">
                        <InputCheckbox @bind-Value="Package.ShipmentServices.Saturday"
                                       class="form-check-input"
                                       disabled="@( !Package.ManualEdit )" />
                        <label class="form-check-label">Sobota</label>
                    </div>
                    <div class="form-check">
                        <InputCheckbox @bind-Value="Package.ShipmentServices.COD"
                                       class="form-check-input"
                                       disabled="@( !Package.ManualEdit )" />
                        <label class="form-check-label">Pobranie</label>
                    </div>
                </div>
            </div>

            <!-- Additional Options Card -->
            <div class="card shadow-sm p-3 mb-4">
                <h5 class="card-title">Opcje dodatkowe</h5>
                <div class="form-check mb-4">
                    <InputCheckbox @bind-Value="Package.ManualEdit" class="form-check-input" />
                    <label class="form-check-label text-danger fw-bold">Modyfikuj dane ręcznie</label>
                </div>

                <div class="mb-4 d-flex flex-column">
                    <button class="btn btn-outline-primary" @onclick=SearchAddress>Pobierz adres</button>
                </div>

                <div class="d-flex flex-column gap-2 mb-4">
                    <button class="btn @(!RoutesStatus.DPDClosed ? "btn-success" : "btn-outline-success")"
                            @onclick="() => CloseRoute(Courier.DPD)"
                            disabled="@RoutesStatus.DPDClosed">
                        Zamknij Trasę DPD
                    </button>

                    <button class="btn @(!RoutesStatus.GLSClosed ? "btn-warning" : "btn-outline-warning")"
                            @onclick="() => CloseRoute(Courier.GLS)"
                            disabled="@RoutesStatus.GLSClosed">
                        Zamknij Trasę GLS
                    </button>

                    <button class="btn @(!RoutesStatus.FedexClosed ? "btn-primary" : "btn-outline-primary")"
                            @onclick="() => CloseRoute(Courier.Fedex)"
                            disabled="@RoutesStatus.FedexClosed">
                        Zamknij Trasę Fedex
                    </button>
                </div>
                <div class="mb-4 d-flex flex-column">
                    <button class="btn @(Package.Id == 0 ? "btn-outline-info" : "btn-info")" disabled="@(Package.Id == 0)" @onclick=SendEmail>Wyślij mail do opiekuna</button>
                </div>
            </div>
        </div>
    </div>
</div>

<Toast FocusAfterCloseInput="InputRef" @ref="Toast" />
<EmailModal @ref="EmailModal" />
<ShipmentModal @ref="ShipmentModal" OnOk="OnShipmentOkClicked" />
<ConfirmDialog @ref="ConfirmDialog"/>
<AddressInvoiceModal @ref="AddressInvoiceModal" OnConfirmed="OnAddressModalConfirmed" />
<PackingListModal @ref="PackingListModal" OnSaveNumber="HandlePackingListSave" OnPrintLabel="HandlePackingListPrint" />
<PasswordModal @ref="PasswordModal" />

@code {
    private string Barcode { get; set; } = string.Empty;
    private PackageData Package { get; set; } = new();
    private WorkstationSettings WorkstationSettings = new();
    private AppSettings AppSettings => AppOptions.Value;
    private ElementReference InputRef;
    private RoutesStatus RoutesStatus = new();

    // Timer for checking closed routes
    private System.Threading.Timer? Timer;

    private ShipmentModal ShipmentModal = new();
    private ConfirmDialog ConfirmDialog = new();
    private Toast Toast = new();
    private EmailModal EmailModal = new();
    private AddressInvoiceModal AddressInvoiceModal = new();
    private PackingListModal PackingListModal = new();
    private PasswordModal PasswordModal = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            WorkstationSettings = await WorkstationService.GetSettingsAsync();

            // Auto-refresh every 1 minute.
            Timer = new System.Threading.Timer(async _ =>
            {
                await InvokeAsync(CheckRouteStatus);
            }, null, TimeSpan.Zero, TimeSpan.FromSeconds(AppSettings.Intervals.RefreshRoutesStatus));
        }
        catch (Exception ex)
        {
            Toast.Show("Błąd!", $"Błąd przy próbie pobrania ustawień stanowiska: {ex.Message}");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("blazorFocus.focusElement", InputRef);
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrEmpty(Barcode))
        {
            await LoadData();
        }
    }

    private async Task LoadData()
    {
        try
        {
            var response = await ShipmentService.GetShipmentDataByBarcode(Barcode);
            if (response == null)
            {
                Toast.Show("Brak paczki!", $"Nie znalaziono paczki o podanym kodzie kreskowym w systmie");
                return;
            }

            Package = response;
            if (Package.WysNumber != 0)
            {
                ConfirmDialog.Show(
                    title: "Usuń przesyłkę",
                    message: $"Przesyłka do tej paczki została wygenerowana dnia {Package.DateShipped} przez {Package.PackingUser}. Czy chcesz ją usunąć?",
                    onConfirm: async () =>
                    {
                        try
                        {
                            await ShipmentService.DeleteShipment(Package.Courier, Package.WysNumber, Package.WysType);
                            Toast.Show("Sukces!", "Przesyłka została usunięta.", ToastType.Success);
                        }
                        catch (Exception ex)
                        {
                            Toast.Show("Błąd!", $"Błąd przy próbie usunięcia paczki: {ex.Message}");
                        }
                        finally
                        {
                            await ClearData();
                            await JSRuntime.InvokeVoidAsync("blazorFocus.focusElement", InputRef);
                        }
                    },
                    onCancel: async () =>
                    {
                    }
                );
            }
        }
        catch (Exception ex)
        {
            Toast.Show("Błąd!", $"Błąd przy próbie pobrania danych paczki: {ex.Message}");
            Barcode = string.Empty;
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
            await JSRuntime.InvokeVoidAsync("blazorFocus.focusElement", InputRef);
        }
    }


    private async Task SendPackage()
    {
        try
        {
            // Validate courier allowed for generating labels
            if (CourierHelper.AllowedCouriersForLabel.Contains(Package.Courier))
            {
                var response = await ShipmentService.SendPackage(Package);

                if (string.IsNullOrEmpty(response?.TrackingNumber))
                {
                    var msg = string.IsNullOrWhiteSpace(response?.ErrorMessage) ? "Nie udało się wygenerować przesyłki!" : response.ErrorMessage;
                    Toast.Show("Błąd!", msg);
                    return;
                }

                if (string.IsNullOrEmpty(response.LabelBase64))
                {
                    var msg = string.IsNullOrWhiteSpace(response.ErrorMessage) ? "Nie udało się wygenerować etykiety kurierskiej!" : response.ErrorMessage;
                    Toast.Show("Błąd!", msg);
                    return;
                }

                var labelContent = response.LabelBase64;
                await ClientPrinterService.PrintAsync(WorkstationSettings.PrinterLabel, response.LabelType.ToString(), labelContent);
                ShipmentModal.Show(Barcode, response.TrackingNumber, response.LabelBase64, response.LabelType, WorkstationSettings.PrinterLabel, Package.HasInvoice, false);
                if (Package.HasInvoice)
                {
                    await ClientPrinterService.PrintCrystalAsync(WorkstationSettings.PrinterInvoice, Package.Recipient.Country != "PL" ? "InvoiceEN" : "InvoicePL", new Dictionary<string, string> { { "DocumentId", Package.InvoiceId.ToString() } });
                }
                await ClearData();
            }
            else
            {
                await PackingListModal.Show(Package.Recipient, Package.Courier.GetDescription());
            }
        }
        catch (Exception ex)
        {
            Toast.Show("Błąd!", $"Błąd przy próbie wysłania paczki: {ex.Message}", ToastType.Error, 10000);
            await ClearData();
        }
    }

    private async Task HandlePackingListSave(string trackingNumber)
    {
        try
        {
            Package.TrackingNumber = trackingNumber;
            var response = await ShipmentService.SendPackage(Package);
        }
        catch (Exception ex)
        {
            Toast.Show("Błąd!", $"Błąd przy próbie zapisu numeru przesyłki: {ex.Message}");
        }
        finally
        {
            await ClearData();
            await JSRuntime.InvokeVoidAsync("blazorFocus.focusElement", InputRef);
        }
    }

    private async Task HandlePackingListPrint(Recipient recipient)
    {
        try
        {          
            await ClientPrinterService.PrintCrystalAsync(WorkstationSettings.PrinterLabel, "Label", new Dictionary<string, string> { { "Kod Kreskowy", Barcode } });
        }
        catch (Exception ex)
        {
            Toast.Show("Błąd!", $"Błąd przy próbie drukowania etykiety wewnętrznej: {ex.Message}");
        }
        finally
        {
            await ClearData();
            await JSRuntime.InvokeVoidAsync("blazorFocus.focusElement", InputRef);
        }
    }

    private async Task ClearData()
    {
        Package = new();
        Barcode = string.Empty;
        await JSRuntime.InvokeVoidAsync("blazorFocus.focusElement", InputRef);
        await InvokeAsync(StateHasChanged);
    }

    private void SendEmail()
    {
        EmailModal.ShowModal(Package.Recipient.Name, Package.PackageName, Package.InvoiceName, Package.Representative, Package.RepresentativeEmail);
    }

    private async Task SearchAddress()
    {
        await AddressInvoiceModal.ShowAsync();
    }

    private void OnAddressModalConfirmed((Recipient Recipient, SearchInvoiceResult? Invoice) data)
    {
        Package.Recipient = data.Recipient;
        Package.InvoiceId = data.Invoice?.InvoiceId ?? 0;
        Package.InvoiceName = data.Invoice?.InvoiceName ?? string.Empty;
        Package.ManualEdit = true;
        Package.ManualSend = true;
    }

    private async Task CheckRouteStatus()
    {
        try
        {
            RoutesStatus = await ShipmentService.GetRoutesStatus();
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Toast.Show("Błąd!", $"Błąd przy próbie sprawdzenia statusu tras kurierskich: {ex.Message}");
        }
    }

    private async Task CloseRoute(Courier courier)
    {
        try
        {
            var password = await PasswordModal.ShowAsync("Wprowadź hasło do zamknięcia trasy");
            if (password == null)
                return;

            bool valid = await AuthService.ValidatePasswordAsync(password);
            if (!valid)
            {
                Toast.Show("Błąd!", "Błędne hasło");
                return;
            }

            var shipmentsToClose = await ShipmentService.GetRoutePackages(courier);
            if (shipmentsToClose.Count == 0)
            {
                Toast.Show("Infromacja", $"Nie wysłano dziś żadnej przesyłki. Musi istnieć conajmniej jedna wysyłka aby zamknąć trasę.", ToastType.Info);
                return;
            }

            ConfirmDialog.Show(
                title: "Zamknięcie trasy kurierskiej",
                message: $"Zostanie zamkniętych {shipmentsToClose.Count} wysyłek. Czy na pewno chcesz zamknąć trasę dla kuriera {courier.GetDescription()}?",
                onConfirm: async () =>
                {
                    try
                    {
                        var protocol = await ShipmentService.CloseRoute(courier);
                        if (!string.IsNullOrEmpty(protocol.ErrorMessage))
                        {
                            Toast.Show("Błąd", $"Nie udało się zamknąć trasy. Bład: {protocol.ErrorMessage}", ToastType.Error);
                            return;
                        }

                        if (protocol.DataBase64.Any())
                        {
                            foreach (var data in protocol.DataBase64)
                            {
                                await ClientPrinterService.PrintAsync(WorkstationSettings.PrinterInvoice, protocol.DataType.ToString(), data);
                            }
                        }

                        switch (courier)
                        {
                            case Courier.DPD:
                                RoutesStatus.DPDClosed = true;
                                break;
                            case Courier.GLS:
                                RoutesStatus.GLSClosed = true;
                                break;
                            case Courier.Fedex:
                                RoutesStatus.FedexClosed = true;
                                break;
                        }
                        await InvokeAsync(StateHasChanged);
                        Toast.Show("Sukces!", $"Trasa dla kuriera {courier.GetDescription()} została zamknięta.", ToastType.Success);
                    }
                    catch (Exception ex)
                    {
                        Toast.Show("Błąd!", $"Błąd przy próbie zamknięcia trasy: {ex.Message}");
                    }
       
                },
                onCancel: async () =>
                {
                    
                }
            );
        }
        catch (Exception ex)
        {
            Toast.Show("Błąd!", $"Błąd przy próbie zamknięcia trasy: {ex.Message}");
        }
    }

    private async Task OnShipmentOkClicked((string ScannedCode, string TrackingNumber) data)
    {
        await JSRuntime.InvokeVoidAsync("blazorFocus.focusElement", InputRef);
    }

    public void Dispose()
    {
        Timer?.Dispose();
    }
}
