@if (IsVisible)
{
    <div class="modal-backdrop @(IsVisible ? "show" : "")">
        <div class="modal-container">
            <div class="modal-header">
                <h5 class="modal-title">Połącz kuwety</h5>
                <button type="button" class="btn-close" @onclick="Close" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Wybierz kuwety do połączenia z wybraną:</p>
                <table class="table table-hover table-tall">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Nazwa</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var jl in AvailableJls)
                        {
                            <tr>
                                <td>
                                    <input type="checkbox" checked="@SelectedJlsNames.Contains(jl.Name)"
                                           @onchange="e => OnCheckboxChanged(e.Value!, jl.Name)" />
                                </td>
                                <td>@jl.Name</td>
                            </tr>
                        }

                    </tbody>
                </table>
            </div>
            <div class="modal-footer d-flex gap-2 w-100">
                <button class="btn btn-primary btn-lg tall-btn" style="flex: 7;" @onclick="Confirm">Połącz zaznaczone kuwety</button>
                <button class="btn btn-secondary btn-lg tall-btn" style="flex: 3;" @onclick="Close">Nie łącz kuwet</button>
            </div>
        </div>
    </div>
}

@code {
    private TaskCompletionSource<List<string>>? _tcs;

    private bool IsVisible = false;
    private List<JlData> AvailableJls = new();
    private List<string> SelectedJlsNames = new();

    public Task<List<string>> Show(List<JlData> availableJls)
    {
        AvailableJls = availableJls;
        SelectedJlsNames = new List<string>();
        IsVisible = true;
        StateHasChanged();

        _tcs = new TaskCompletionSource<List<string>>();
        return _tcs.Task;
    }

    private void OnCheckboxChanged(object value, string jlName)
    {
        bool isChecked = (bool)value;
        if (isChecked)
        {
            if (!SelectedJlsNames.Contains(jlName))
                SelectedJlsNames.Add(jlName);
        }
        else
        {
            SelectedJlsNames.Remove(jlName);
        }
    }

    private void Close()
    {
        IsVisible = false;
        _tcs?.TrySetResult(new List<string>());
        StateHasChanged();
    }

    private void Confirm()
    {
        IsVisible = false;
        _tcs?.TrySetResult(SelectedJlsNames);
        StateHasChanged();
    }
}
