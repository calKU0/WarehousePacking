@if (IsVisible)
{
    <div class="modal-backdrop @(IsVisible ? "show" : "")">
        <div class="modal-container">
            <div class="modal-header">
                <h5 class="modal-title">Połącz kuwety</h5>
                <button type="button" class="btn-close" @onclick="Close" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Wybierz kuwety do połączenia z wybraną:</p>
                <table class="table table-hover table-tall">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Jl</th>
                            <th>Lokalizacja</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var jl in AvailableJls)
                        {
                            <tr>
                                <td>
                                    <input type="checkbox" checked="@SelectedJlsNames.Contains((jl.Name, jl.LocationCode))"
                                           @onchange="e => OnCheckboxChanged(e.Value!, jl.Name, jl.LocationCode)" />
                                </td>
                                <td>@jl.Name</td>
                                <td>@jl.LocationCode</td>
                            </tr>
                        }

                    </tbody>
                </table>
            </div>
            <div class="modal-footer d-flex gap-2 w-100">
                <button class="btn btn-primary btn-lg tall-btn" style="flex: 7;" @onclick="Confirm">Połącz zaznaczone kuwety</button>
                <button class="btn btn-secondary btn-lg tall-btn" style="flex: 3;" @onclick="Close">Nie łącz kuwet</button>
            </div>
        </div>
    </div>
}

@code {
    private TaskCompletionSource<List<(string jlName, string locationCode)>>? _tcs;

    private bool IsVisible = false;
    private List<JlData> AvailableJls = new();
    private List<(string jlName, string locationCode)> SelectedJlsNames = new();

    public Task<List<(string jlName, string locationCode)>> Show(List<JlData> availableJls)
    {
        AvailableJls = availableJls;
        SelectedJlsNames = new List<(string jlName, string locationCode)>();
        IsVisible = true;
        StateHasChanged();

        _tcs = new TaskCompletionSource<List<(string jlName, string locationCode)>>();
        return _tcs.Task;
    }

    private void OnCheckboxChanged(object value, string jlName, string location)
    {
        bool isChecked = (bool)value;
        if (isChecked)
        {
            if (!SelectedJlsNames.Contains((jlName, location)))
                SelectedJlsNames.Add((jlName, location));
        }
        else
        {
            SelectedJlsNames.Remove((jlName, location));
        }
    }

    private void Close()
    {
        IsVisible = false;
        _tcs?.TrySetResult(new List<(string jlName, string locationCode)>());
        StateHasChanged();
    }

    private void Confirm()
    {
        IsVisible = false;
        _tcs?.TrySetResult(SelectedJlsNames);
        StateHasChanged();
    }
}
