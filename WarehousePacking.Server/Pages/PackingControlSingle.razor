@using WarehousePacking.Server.Services
@using WarehousePacking.Shared.DTOs.Requests
@using WarehousePacking.Shared.Enums
@using WarehousePacking.Shared.Helpers

@page "/kontrola-pakowania/{jl}/single"
@layout NoNavLayout
@inherits PackingPageBase

<div class="container-fluid d-flex flex-column vh-100 p-3 pack-control">
    <PackingHeader JlItems="JlItems"
                   CurrentJl="CurrentJl"
                   Username="@UserSession.Username"
                   OnManagerClick="HandleManagerClick"
                   OnManagerRequestPassword="OnManagerButtonClick" />

    <ScanInput @ref="ScanInputComponent" OnKeyDown="HandleCodeInput" Disabled="@MovedProduct" />

    <PackingTables JlItems="JlItems"
                   PackedItems="PackedItems"
                   SelectedPackedItem="SelectedPackedItem"
                   HighlightedRows="HighlightedRows"
                   OnRowDoubleClick="OpenProductModal"
                   OnPackedItemSelect="SelectPackedItem"
                   CourierConfiguration="CourierConfiguration" 
                   Disabled="@MovedProduct" />

    <PackingButtons NextPackage="NextPackage"
                    UnpackItem="UnpackItem"
                    Close="Close"
                    FinishPacking="FinishPacking"
                    PackedItems="PackedItems"
                    Settings="Settings" />

    <ProductSelectModal @ref=ProductSelectModal FocusOnClose="ScanInputComponent" OnConfirm="PackItem" />
    <JlSelectModal @ref="JlSelectModal" />
    <PasswordModal @ref=PasswordModal />
    <ConfirmDialog @ref="ConfirmDialog" />
    <CourierModal @ref="CourierModal" />
    <LoggedOperatorsModal @ref="LoggedOperatorsModal" />
    <JlInProgressModal @ref="JlInProgressModal" />
    <PackingJlItemsModal @ref="PackingJlItemsModal" />
    <ChangePackingWarehouseModal @ref="ChangePackingWarehouseModal" />
    <TextBoxModal @ref="TextBoxModal" />

    <FinishPackingModal @ref="FinishPackingModal"
                        Courier="@CurrentJl.Courier"
                        Country="@CurrentJl.Country"
                        CourierSrc="@CurrentJl.LogoCourier"
                        OnCourierLabel="HandleCourierLabel"
                        OnInternalBarcode="HandleInternalBarcode" />

    <DimensionsModal @ref="DimensionsModal" />
    <ShipmentModal @ref="ShipmentModal" OnOk="HandleShipmentOkClick" />

    <Toast FocusAfterCloseInput="ScanInputComponent" @ref="Toast" />
</div>

@code {
    private bool MovedProduct { get; set; } = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await base.OnAfterRenderAsync(firstRender);

        if (firstRender)
        {
            Toast.Show("Pakowanie pojedyńcze", "Kuweta zawiera towary dla wielu klientów.\nKAŻDY TOWAR NALEŻY SPAKOWAĆ DO OSOBNEJ PACZKI!", ToastType.Info);
        }
    }

    public void FillJlData(JlItemDto item)
    {
        CurrentJl.Courier = item.Courier;
        CurrentJl.CourierName = item.CourierName;
        //CurrentJl.LogoCourier = item.LogoCourier;
        CurrentJl.ShipmentServices = item.ShipmentServices;
        CurrentJl.ClientSymbol = item.ClientSymbol;
        CurrentJl.Country = item.DestinationCountry;

        CurrentJl.AddressName = item.AddressName;
        CurrentJl.AddressCountry = item.AddressCountry;
        CurrentJl.AddressCity = item.AddressCity;
        CurrentJl.AddressStreet = item.AddressStreet;
        CurrentJl.AddressPostalCode = item.AddressPostalCode;
        CurrentJl.ClientName = item.ClientName;
        CurrentJl.ClientId = Convert.ToInt32(item.ClientErpId);
        StateHasChanged();
    }

    public void ClearJlData()
    {
        CurrentJl.Courier = Courier.Unknown;
        CurrentJl.CourierName = "MIX";
        CurrentJl.LogoCourier = string.Empty;
        CurrentJl.ShipmentServices = new();
        CurrentJl.ClientSymbol = "MIX";
        CurrentJl.Country = string.Empty;

        CurrentJl.AddressCity = string.Empty;
        CurrentJl.AddressName = string.Empty;
        CurrentJl.AddressCountry = string.Empty;
        CurrentJl.AddressStreet = string.Empty;
        CurrentJl.AddressPostalCode = string.Empty;
        CurrentJl.ClientName = string.Empty;
        CurrentJl.ClientId = 0;
        CurrentJl.PackageClosed = false;
        PackageId = 0;
        StateHasChanged();
    }

    protected override async Task PackItem(decimal qty)
    {
        try
        {
            if (SelectedItem == null || JlItems == null) return;
            FillJlData(SelectedItem);
            await LoadCourierConfiguration();
            await CreatePackage();
            var jlInProgress = new JlInProgressDto
            {
                Name = Jl,
                PackageId = PackageId
            };
            await PackingService.UpdateJlRealization(jlInProgress);
            bool moved = await MoveItemToPacked(SelectedItem, qty);
            if (!moved) 
            {
                ClearJlData();
                ClosePackageRequest closePackageRequest = new()
                {
                    DocumentId = PackageId,
                    Status = DocumentStatus.Delete
                };
                await PackingService.ClosePackage(closePackageRequest);
                return;
            }

            MovedProduct = true;
            FinishPacking();
        }
        catch (Exception ex)
        {
            Toast.Show("Błąd!", $"Błąd przy próbie spakowania towaru: {ex.Message}");
        }
        finally
        {
            SelectedItem = null;
            await ScanInputComponent.FocusAsync();
            await InvokeAsync(StateHasChanged);
        }
    }

    protected override async Task UnpackItem()
    {
        if (SelectedPackedItem == null) return;

        var request = new RemovePackedPositionRequest
        {
            PackingDocumentId = PackageId,
            SourceDocumentId = SelectedPackedItem.DocumentId,
            SourceDocumentType = SelectedPackedItem.DocumentType,
            PositionNumber = SelectedPackedItem.ErpPositionNumber,
            Quantity = SelectedPackedItem.JlQuantity,
            Weight = SelectedPackedItem.ItemWeight,
            Volume = SelectedPackedItem.ItemVolume
        };

        var success = await PackingService.RemovePackedPosition(request);
        if (!success)
        {
            Toast.Show("Błąd!", "Nie udało się usunąć spakowanej pozycji.");
            return;
        }
        var jlInProgress = new JlInProgressDto
        {
            Name = Jl,
            PackageId = 0
        };
        await PackingService.UpdateJlRealization(jlInProgress);

        var existingLeft = JlItems.FirstOrDefault(j => j.ItemCode == SelectedPackedItem.ItemCode);
        if (existingLeft != null) existingLeft.JlQuantity += SelectedPackedItem.JlQuantity;
        else JlItems.Add(SelectedPackedItem);

        PackedItems.Remove(SelectedPackedItem);
        HighlightedRows.Remove(SelectedPackedItem.ItemCode);
        SelectedPackedItem = null;

        MovedProduct = false;
        ClearJlData();
        await ScanInputComponent.FocusAsync();
    }

    protected override async Task HandleShipmentOkClick((string ScannedCode, string TrackingNumber) data)
    {
        try
        {
            switch (_currentPackingFlow)
            {
                case PackingFlow.FinishPacking:
                    await CloseJlInWMS(CurrentJl.CourierName, data.ScannedCode, data.TrackingNumber, DocumentStatus.Ready);
                    PackedItems.Clear();
                    MovedProduct = false;
                    ClearJlData();
                    CourierConfiguration = new();
                    CurrentJl.InternalBarcode = string.Empty;
                    break;
            }

            if (!JlItems.Any())
            {
                Navigation.NavigateTo("/kontrola-pakowania");
            }
            else
            {
                await ScanInputComponent.FocusAsync();
            }
        }
        catch (Exception ex)
        {
            Toast.Show("Błąd!", $"Błąd przy próbie finalizacji pakowania: {ex.Message}");
            await ScanInputComponent.FocusAsync();
        }
    }

    protected override async Task HandleInternalBarcode()
    {
        try
        {
            FinishPackingModal.Hide();

            string internalBarcode = await TextBoxModal.Show("Numer wewnętrzny", "Wprowadź numer wewnętrzny", "Kod kreskowy");
            if (string.IsNullOrEmpty(internalBarcode)) return;

            Dimensions dimensions = new();
            if (Settings.PackingLevel == PackingLevel.Dół && !CourierHelper.AllowedCouriersForLabel.Contains(CurrentJl.Courier))
            {
                dimensions = await DimensionsModal.Show();
            }

            await CloseJlInWMS(CurrentJl.CourierName, internalBarcode, internalBarcode, DocumentStatus.Ready);
            await ClosePackage(internalBarcode, dimensions);
            if (Settings.PackingLevel == PackingLevel.Dół && !CourierHelper.AllowedCouriersForLabel.Contains(CurrentJl.Courier))
            {
                await ClientPrinterService.PrintCrystalAsync(Settings.PrinterLabel, "Label", new Dictionary<string, string> { { "Kod Kreskowy", internalBarcode } });
            }

            switch (_currentPackingFlow)
            {
                case PackingFlow.FinishPacking:
                    PackedItems.Clear();
                    MovedProduct = false;
                    ClearJlData();
                    CourierConfiguration = new();
                    CurrentJl.InternalBarcode = string.Empty;
                    break;
            }

            if (!JlItems.Any())
                Navigation.NavigateTo("/kontrola-pakowania");
            else
                await ScanInputComponent.FocusAsync();
        }
        catch (Exception ex)
        {
            Toast.Show("Błąd!", $"Błąd przy próbie finalizacji pakowania: {ex.Message}");
            await ScanInputComponent.FocusAsync();
        }
    }
}
